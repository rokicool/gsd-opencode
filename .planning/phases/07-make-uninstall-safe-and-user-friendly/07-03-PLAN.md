---
phase: 07-make-uninstall-safe-and-user-friendly
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - test/integration/uninstall-safety.test.js
  - test/integration/helpers/test-utils.js
  - test/fixtures/integration/manifest-test/
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Integration test verifies namespace protection doesn't delete user files"
    - "Integration test verifies manifest-based file tracking"
    - "Integration test verifies dry-run preview matches actual removal"
    - "Integration test verifies backup files can be restored"
    - "Integration test verifies recovery workflow"
    - "Integration test verifies non-empty directories are preserved"
    - "Integration test runs successfully in CI environment"
  artifacts:
    - path: "test/integration/uninstall-safety.test.js"
      provides: "Integration tests for safety features"
      contains: ["describe('Safety Features'"]
    - path: "test/integration/helpers/test-utils.js"
      provides: "Enhanced test utilities for safety verification"
      exports: ["verifyNamespaceProtection", "restoreFromBackup"]
    - path: "test/fixtures/integration/manifest-test/"
      provides: "Test fixtures for manifest scenarios"
  key_links:
    - from: "test/integration/uninstall-safety.test.js"
      to: "src/commands/uninstall.js"
      via: "CLI spawn for end-to-end testing"
    - from: "test/integration/uninstall-safety.test.js"
      to: "src/services/manifest-manager.js"
      via: "Manifest creation and loading"
---

<objective>
Create integration tests that verify the manifest-based safety system works end-to-end, including namespace protection, dry-run accuracy, backup integrity, and recovery workflow.

Purpose: Validate that all safety features work together correctly with actual file system operations and that user data is never at risk.
Output: Integration test suite covering safety boundaries, dry-run accuracy, backup/recovery, and edge cases.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/commands/uninstall.js
@src/services/manifest-manager.js
@src/services/backup-manager.js
@test/integration/helpers/test-utils.js (if exists)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create enhanced test utilities for safety testing</name>
  <files>test/integration/helpers/test-utils.js</files>
  <action>
Enhance test utilities with helper functions specific to testing safety features.

Add the following functions to test/integration/helpers/test-utils.js (create if doesn't exist):

1. `createMockInstallWithMixedFiles(installDir)`:
   - Creates realistic GSD-OpenCode installation with mixed files
   - Includes allowed files (gsd-*) and user files (non-gsd)
   - Returns list of expected removed vs preserved files
   - Creates proper INSTALLED_FILES.json manifest

2. `verifyNamespaceProtection(installDir, removedFiles, preservedFiles)`:
   - Verifies only files in allowed namespaces were removed
   - Verifies non-gsd files still exist
   - Verifies non-empty directories were preserved
   - Returns boolean indicating pass/fail

3. `verifyDryRunAccuracy(dryRunOutput, actualRemovedFiles)`:
   - Parses dry-run output
   - Compares predicted removals with actual removals
   - Verifies "Will Remove" list matches reality
   - Returns discrepancies if any

4. `restoreFromBackup(backupDir, targetDir)`:
   - Copies files from backup back to target
   - Used to test recovery workflow
   - Returns list of restored files

5. `verifyBackupIntegrity(backupDir, originalFiles)`:
   - Compares backup files against original files
   - Verifies all files backed up correctly
   - Returns { matches: boolean, differences: [] }

6. `createManifest(installDir, files)`:
   - Creates INSTALLED_FILES.json with specified files
   - Calculates hashes and sizes automatically
   - Returns manifest object

7. `calculateDirectoryContents(dirPath)`:
   - Returns { files: [], directories: [], totalSize: number }
   - Used for verification in tests

8. `simulateTypedInput(word)`:
   - Returns mock function that simulates user typing
   - For testing typed confirmation in integration tests

If file exists:
- Add these functions alongside existing utilities
- Ensure no naming conflicts

If creating new file:
- Add proper imports (fs/promises, path, crypto)
- Export all functions
- Add JSDoc documentation
</action>
  <verify>
grep -n "verifyNamespaceProtection\|createMockInstallWithMixedFiles\|verifyDryRunAccuracy" test/integration/helpers/test-utils.js
  </verify>
  <done>Test utilities include namespace protection verification and backup helpers</done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests for manifest and namespace protection</name>
  <files>test/integration/uninstall-safety.test.js</files>
  <action>
Create comprehensive integration tests for the safety features.

Test setup:
1. Use temporary directories in os.tmpdir() for isolation
2. Create realistic installations with:
   - Multiple allowed directories (agents/gsd-*, command/gsd/*, get-shit-done/)
   - User directories (agents/other, command/other)
   - Mixed content (gsd files and user files in same parent)
   - Proper INSTALLED_FILES.json manifest

**Integration test cases:**

**Test 1: Namespace protection - preserves user files**
- Create installation with:
  - agents/gsd-debugger/ (gsd file - should be removed)
  - agents/user-custom/ (user file - should be preserved)
  - command/gsd/install.js (gsd file - should be removed)
  - command/other/tool.js (user file - should be preserved)
- Run uninstall with --force (skip confirmation)
- Verify:
  - gsd-debugger directory removed
  - user-custom directory still exists
  - gsd/install.js removed
  - other/tool.js still exists

**Test 2: Manifest-based removal**
- Create installation with manifest listing specific files
- Add extra file in allowed namespace NOT in manifest
- Run uninstall
- Verify:
  - Files in manifest are removed
  - Extra file (not in manifest) is NOT removed (extra safety)
  - Warning shown about extra file

**Test 3: Fallback mode (no manifest)**
- Create installation without INSTALLED_FILES.json
- Run uninstall
- Verify:
  - Warning shown about fallback mode
  - Uses namespace patterns for removal
  - Only gsd-* files removed

**Test 4: Directory preservation (non-empty)**
- Create agents/ directory with:
  - gsd-debugger/ (gsd file)
  - user-custom/ (user file)
- Run uninstall
- Verify:
  - gsd-debugger/ removed
  - user-custom/ still exists
  - agents/ directory preserved (not empty)

**Test 5: Directory removal (empty after cleanup)**
- Create installation with only gsd-* files
- Run uninstall
- Verify:
  - All files removed
  - Empty directories removed
  - Installation directory removed if now empty

**Test 6: Dry-run accuracy**
- Create test installation with mixed files
- Run uninstall --dry-run
- Capture output
- Parse "Will Remove", "Will Skip", "Will Preserve" sections
- Run uninstall without --dry-run
- Verify actual removal matches dry-run prediction exactly

**Test 7: Full backup and recovery workflow**
- Create test installation
- Run uninstall (creates backup)
- Verify backup directory created with timestamp
- Verify all files backed up correctly
- Restore files from backup using cp -r
- Verify installation is functional after restore
- Run check command to verify integrity

**Test 8: No-backup option**
- Run uninstall --no-backup
- Verify no backup directory created
- Verify files still removed correctly

**Test 9: Backup retention and integrity**
- Create multiple backups (simulate multiple uninstalls)
- Verify each backup is date-stamped
- Verify backup contains exact copies (compare file contents)
- Verify backup retention (keep last 5)

**Test 10: Typed confirmation flow**
- Mock interactive input to simulate typing
- Test correct confirmation ('uninstall')
- Test incorrect confirmation (wrong word)
- Test case-insensitivity ('Uninstall', 'UNINSTALL')
- Test Ctrl+C cancellation

**Test 11: Safety summary accuracy**
- Create installation with known file counts
- Run uninstall and capture safety summary
- Verify counts match reality:
  - "N files will be removed"
  - "N directories will be removed"
  - "N directories preserved"

**Test 12: Mixed scope scenario**
- Create both global and local installations
- Run uninstall without --global or --local
- Verify appropriate error about ambiguity
- Specify --global and verify only global removed
- Verify local still intact

**Test 13: Permission scenarios**
- Create read-only files in allowed namespace
- Verify appropriate error handling
- Verify process continues with other files

**Test 14: Large installation performance**
- Create installation with 50+ files across multiple directories
- Run uninstall
- Verify performance is acceptable (< 5 seconds)
- Verify all files backed up and removed correctly

**Test execution:**
- Each test cleans up after itself
- Use beforeEach/afterEach for setup/teardown
- Tests must be independent (no shared state)
- Use execa or child_process.spawn for CLI testing

**Assertions:**
- Use expect() for all assertions
- Test both positive and negative cases
- Verify file existence/non-existence with fs.access
- Verify backup integrity by comparing file hashes
</action>
  <verify>
npm test -- test/integration/uninstall-safety.test.js 2>&1 | grep -E "(PASS|FAIL|Test Files)"
  </verify>
  <done>All integration tests pass, verifying namespace protection, dry-run, backup, and recovery</done>
</task>

<task type="auto">
  <name>Task 3: Create test fixtures for manifest scenarios</name>
  <files>test/fixtures/integration/manifest-test/</files>
  <action>
Create test fixtures for manifest-based testing scenarios.

Create directory structure: test/fixtures/integration/manifest-test/

**Fixture 1: complete-installation/**
Complete GSD-OpenCode installation with manifest:
```
complete-installation/
â”œâ”€â”€ INSTALLED_FILES.json (valid manifest with all files)
â”œâ”€â”€ VERSION
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ gsd-debugger/
â”‚   â”‚   â””â”€â”€ SKILL.md
â”‚   â””â”€â”€ gsd-planner/
â”‚       â””â”€â”€ SKILL.md
â”œâ”€â”€ command/
â”‚   â””â”€â”€ gsd/
â”‚       â”œâ”€â”€ install.js
â”‚       â””â”€â”€ uninstall.js
â””â”€â”€ get-shit-done/
    â””â”€â”€ workflows/
        â””â”€â”€ execute.md
```

**Fixture 2: partial-installation/**
Partial installation (some files missing):
```
partial-installation/
â”œâ”€â”€ INSTALLED_FILES.json (references files that don't exist)
â”œâ”€â”€ VERSION
â””â”€â”€ agents/
    â””â”€â”€ gsd-debugger/
        â””â”€â”€ SKILL.md
```

**Fixture 3: mixed-namespace/**
Installation with both gsd and non-gsd files:
```
mixed-namespace/
â”œâ”€â”€ INSTALLED_FILES.json (only lists gsd files)
â”œâ”€â”€ VERSION
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ gsd-debugger/
â”‚   â”‚   â””â”€â”€ SKILL.md
â”‚   â””â”€â”€ user-custom/
â”‚       â””â”€â”€ config.json
â””â”€â”€ command/
    â”œâ”€â”€ gsd/
    â”‚   â””â”€â”€ install.js
    â””â”€â”€ other-tool/
        â””â”€â”€ script.js
```

**Fixture 4: no-manifest/**
Installation without manifest (fallback mode test):
```
no-manifest/
â”œâ”€â”€ VERSION
â”œâ”€â”€ agents/
â”‚   â””â”€â”€ gsd-debugger/
â”‚       â””â”€â”€ SKILL.md
â””â”€â”€ command/
    â””â”€â”€ gsd/
        â””â”€â”€ install.js
```

Each fixture should include:
- Realistic file content (can be minimal)
- Proper directory structure
- Valid INSTALLED_FILES.json (where applicable)
</action>
  <verify>
ls -la test/fixtures/integration/manifest-test/ &&
ls test/fixtures/integration/manifest-test/complete-installation/
  </verify>
  <done>Test fixtures created for manifest, namespace, and fallback scenarios</done>
</task>

<task type="auto">
  <name>Task 4: Update STATE.md with Phase 7 progress</name>
  <files>.planning/STATE.md</files>
  <action>
Update the STATE.md file to reflect Phase 7 completion status.

Changes to make:
1. Update "Current Phase" to show Phase 7 planning/execution
2. Update Phase 7 status in the progress table from "ðŸ”µ Planned" to "ðŸŸ¡ In Progress" (or "ðŸŸ¢ Complete" if done)
3. Add Phase 7 details to "Recently Completed" section:
   - Plans created (07-01, 07-02, 07-03)
   - Key features: Manifest-based safety, namespace protection, typed confirmation

4. Update "Next Action" based on execution status

Be careful to preserve all existing content and only update specific fields.
</action>
  <verify>
grep -n "Phase 7" .planning/STATE.md | head -5
  </verify>
  <done>STATE.md updated with Phase 7 progress and recent completion details</done>
</task>

<task type="auto">
  <name>Task 5: Update ROADMAP.md with Phase 7 completion status</name>
  <files>.planning/ROADMAP.md</files>
  <action>
Update the ROADMAP.md Phase 7 section to mark plans as complete.

Changes to make:
1. Update Phase 7 Plans checkboxes:
   - [x] 07-01-PLAN.md â€” Enhanced uninstall with manifest, namespace protection, dry-run, typed confirmation
   - [x] 07-02-PLAN.md â€” Unit tests for ManifestManager and enhanced uninstall
   - [x] 07-03-PLAN.md â€” Integration tests for safety features

2. Update Success Criteria to include verification steps:
   - All unit tests pass (npm test)
   - All integration tests pass
   - Namespace protection verified (non-gsd files preserved)
   - Dry-run accuracy verified
   - Backup/recovery workflow verified

3. Update "Last updated" timestamp
</action>
  <verify>
grep -A5 "Phase 7:" .planning/ROADMAP.md | grep -E "(07-01|07-02|07-03)"
  </verify>
  <done>ROADMAP.md Phase 7 section updated with completed plan checkboxes</done>
</task>

</tasks>

<verification>
1. Run full test suite: npm test
2. Run integration tests specifically: npm test -- test/integration/uninstall-safety.test.js
3. Verify all tests pass in CI-like environment (no TTY)
4. Check coverage report for integration tests
5. Verify namespace protection: create test with non-gsd file, confirm it's preserved
</verification>

<success_criteria>
- Integration tests verify namespace protection (non-gsd files preserved)
- Integration tests verify manifest-based removal
- Integration tests verify dry-run accuracy
- Integration tests verify backup creation and integrity
- Integration tests verify recovery workflow
- Integration tests verify directory preservation (non-empty)
- All integration tests pass in isolated temp directories
- Tests run successfully in CI environment
- STATE.md and ROADMAP.md updated with Phase 7 completion
</success_criteria>

<output>
After completion, create `.planning/phases/07-make-uninstall-safe-and-user-friendly/07-03-SUMMARY.md`
</output>
</planning_context>
