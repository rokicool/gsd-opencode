---
phase: 07-make-uninstall-safe-and-user-friendly
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/file-ops.js
  - src/services/manifest-manager.js
  - src/commands/uninstall.js
  - src/utils/interactive.js
  - lib/constants.js
  - bin/gsd.js
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Install creates INSTALLED_FILES.json manifest tracking all installed files"
    - "Uninstall only removes files in allowed namespaces (gsd-*)"
    - "Uninstall never deletes folders containing non-gsd-opencode files"
    - "User sees clear warning about what will be removed before uninstall"
    - "User can preview what will be removed without actually removing (--dry-run)"
    - "Backup is created before deletion for potential recovery"
    - "Typed confirmation requires user to type 'uninstall' for extra safety"
    - "Enhanced summary shows file counts, sizes, and backup location"
    - "User receives clear success message with recovery instructions"
  artifacts:
    - path: "src/services/manifest-manager.js"
      provides: "Manifest service for tracking installed files"
      exports: ["ManifestManager"]
    - path: "src/services/file-ops.js"
      provides: "Enhanced to generate manifest during install"
      min_changes: "Add manifest generation to _copyFile method"
    - path: "src/commands/uninstall.js"
      provides: "Safety-first uninstall with namespace protection"
      exports: ["uninstallCommand"]
    - path: "src/utils/interactive.js"
      provides: "promptTypedConfirmation utility"
      exports: ["promptTypedConfirmation"]
    - path: "lib/constants.js"
      provides: "ALLOWED_NAMESPACES and UNINSTALL_BACKUP_DIR constants"
  key_links:
    - from: "src/services/file-ops.js"
      to: "src/services/manifest-manager.js"
      via: "import { ManifestManager }"
      pattern: "manifestManager.addFile"
    - from: "src/commands/uninstall.js"
      to: "src/services/manifest-manager.js"
      via: "load manifest and check namespaces"
      pattern: "manifestManager.load"
    - from: "src/commands/uninstall.js"
      to: "src/services/backup-manager.js"
      via: "create backup before removal"
      pattern: "new BackupManager"
    - from: "src/commands/uninstall.js"
      to: "src/utils/interactive.js"
      via: "promptTypedConfirmation"
      pattern: "await promptTypedConfirmation"
---

<objective>
Implement a manifest-based safety system for uninstall that ensures ONLY files created by gsd-opencode are deleted, with namespace protection, --dry-run preview, typed confirmation, and backup before removal.

Purpose: Prevent accidental data loss by enforcing strict namespace boundaries (gsd-*) and never deleting user files or shared folders.
Output: Enhanced install with manifest generation, safety-first uninstall with namespace protection, typed confirmation, dry-run mode, and backup creation.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-make-uninstall-safe-and-user-friendly/07-CONTEXT.md
@src/services/file-ops.js
@src/commands/uninstall.js
@src/utils/interactive.js
@lib/constants.js
@bin/gsd.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ManifestManager service</name>
  <files>src/services/manifest-manager.js</files>
  <action>
Create a new ManifestManager service that tracks all files installed by gsd-opencode.

**Critical Safety Rule**: The manifest tracks ALL files, but uninstall only removes files in allowed namespaces.

Implementation:
1. Create src/services/manifest-manager.js with ManifestManager class
2. Constructor accepts installPath (root directory)
3. Methods needed:
   - `addFile(absolutePath, relativePath, size, hash)` - Add file to manifest
   - `save()` - Write manifest to INSTALLED_FILES.json
   - `load()` - Read manifest from INSTALLED_FILES.json (returns null if not exists)
   - `getFilesInNamespaces(namespaces)` - Filter files by allowed namespaces
   - `isInAllowedNamespace(filePath)` - Check if path is in allowed namespace

4. Manifest format (INSTALLED_FILES.json):
```json
[
  {
    "path": "/home/user/.config/opencode/agents/gsd-debugger/SKILL.md",
    "relativePath": "agents/gsd-debugger/SKILL.md",
    "size": 2847,
    "hash": "sha256:a1b2c3..."
  }
]
```

5. Namespace checking logic:
   - Allowed namespaces: agents/gsd-*, command/gsd/*, skills/gsd-*/, get-shit-done/*
   - Use path matching to check if file is in allowed namespace
   - NEVER delete files outside these namespaces

6. Add proper JSDoc documentation
7. Export ManifestManager class

Use fs/promises for file operations and crypto for hashing.
</action>
  <verify>
grep -n "class ManifestManager" src/services/manifest-manager.js &&
grep -n "INSTALLED_FILES" src/services/manifest-manager.js &&
grep -n "isInAllowedNamespace\|getFilesInNamespaces" src/services/manifest-manager.js
  </verify>
  <done>ManifestManager service exists with save/load methods and namespace filtering</done>
</task>

<task type="auto">
  <name>Task 2: Add namespace constants to lib/constants.js</name>
  <files>lib/constants.js</files>
  <action>
Add constants for namespace protection and uninstall backup directory.

Add to lib/constants.js:
1. ALLOWED_NAMESPACES array with regex patterns:
   - /^agents\/gsd-/ (agents/gsd-* directories)
   - /^command\/gsd\// (command/gsd/* files)
   - /^skills\/gsd-/ (skills/gsd-* directories)
   - /^get-shit-done\// (get-shit-done/ directory - fully owned)

2. UNINSTALL_BACKUP_DIR constant: '.uninstall-backups'

3. MANIFEST_FILENAME constant: 'INSTALLED_FILES.json'

Ensure all constants are exported and placed logically with related constants.
</action>
  <verify>
grep -n "ALLOWED_NAMESPACES\|UNINSTALL_BACKUP_DIR\|MANIFEST_FILENAME" lib/constants.js
  </verify>
  <done>Namespace constants and manifest filename added to constants</done>
</task>

<task type="auto">
  <name>Task 3: Enhance FileOperations to generate manifest</name>
  <files>src/services/file-ops.js</files>
  <action>
Modify FileOperations class to generate INSTALLED_FILES.json manifest during installation.

Changes to src/services/file-ops.js:
1. Import ManifestManager and MANIFEST_FILENAME from constants
2. Import crypto for hashing
3. In install() method:
   - Create ManifestManager instance
   - Pass manifestManager to _copyRecursive and _copyFile
   - After successful copy, call manifestManager.save()
   - Include manifest file in return result

4. Modify _copyFile() to:
   - Calculate SHA256 hash of file content
   - Get file size
   - Call manifestManager.addFile(absolutePath, relativePath, size, hash)
   - Continue with existing path replacement logic

5. Update _copyRecursive signature to accept manifestManager parameter
6. Pass manifestManager through all recursive calls
7. Update return value to include manifestPath

Ensure existing functionality (path replacement, atomic move, progress) is preserved.
</action>
  <verify>
grep -n "ManifestManager" src/services/file-ops.js &&
grep -n "manifestManager" src/services/file-ops.js &&
grep -n "createHash\|sha256" src/services/file-ops.js
  </verify>
  <done>FileOperations generates manifest with file hashes during installation</done>
</task>

<task type="auto">
  <name>Task 4: Add promptTypedConfirmation to interactive.js</name>
  <files>src/utils/interactive.js</files>
  <action>
Add a new promptTypedConfirmation function that requires typing a specific word for extra safety.

Implementation:
1. Import input from '@inquirer/prompts'
2. Create async function promptTypedConfirmation(message, confirmWord) that:
   - Displays the message with the confirmWord emphasized
   - Uses input() to get user typed response
   - Compares response (case-insensitive) to confirmWord
   - Returns true if matches, false if doesn't match
   - Returns null if user cancels (AbortPromptError)
   - Shows error message and allows retry (up to 3 attempts)
   - On 3rd failure, return false

3. Example usage pattern:
   ```javascript
   const confirmed = await promptTypedConfirmation(
     'This will uninstall GSD-OpenCode. Type "uninstall" to confirm',
     'uninstall'
   );
   ```

4. Add proper JSDoc documentation
5. Export the function alongside existing prompt functions

Follow existing patterns in the file for error handling (AbortPromptError detection).
</action>
  <verify>
grep -n "promptTypedConfirmation" src/utils/interactive.js &&
grep -n "input.*@inquirer/prompts" src/utils/interactive.js
  </verify>
  <done>promptTypedConfirmation function exists with retry logic and AbortPromptError handling</done>
</task>

<task type="auto">
  <name>Task 5: Rewrite uninstall command with safety-first design</name>
  <files>src/commands/uninstall.js</files>
  <action>
Rewrite the uninstall command to implement manifest-based safety with namespace protection.

Key safety principles from CONTEXT.md:
- Only delete files in allowed namespaces (gsd-*)
- Never delete folders containing non-gsd-opencode files
- If manifest missing, use fallback to hardcoded namespace list (still safe)
- Preserve directories that would become non-empty after file removal

Implementation changes:
1. Import new dependencies:
   - ManifestManager from '../services/manifest-manager.js'
   - BackupManager from '../services/backup-manager.js'
   - promptTypedConfirmation from '../utils/interactive.js'
   - ALLOWED_NAMESPACES, UNINSTALL_BACKUP_DIR from constants

2. Add new options support:
   - options.dryRun - preview without removing
   - options.backup (default true) - can be disabled with --no-backup

3. Implement safety-first removal logic:
   ```
   a. Load manifest (if exists) or use fallback namespace patterns
   b. Identify files to remove (only in allowed namespaces)
   c. Categorize:
      - Will Remove: Files in allowed namespaces
      - Will Skip: Files already missing
      - Will Preserve: Files outside namespaces or in non-empty dirs
   d. Show three-category display in dry-run/preview
   ```

4. Enhanced display:
   - Show prominent WARNING header with red/yellow styling
   - Display namespace protection notice
   - Show file counts and sizes
   - Display number of directories that will be preserved vs removed
   - List first 10 files, then "... and N more files"

5. Safety summary before confirmation:
   ```
   Safety Summary:
   • N files will be removed
   • N directories will be removed (will be empty)
   • N directories preserved (contain non-gsd-opencode files)
   • Backup will be created at: [path]
   ```

6. Replace promptConfirmation with promptTypedConfirmation:
   - Require typing 'uninstall'
   - --force still skips confirmation (but maintains namespace protection)

7. Backup creation (if not --no-backup):
   - Create BackupManager with UNINSTALL_BACKUP_DIR
   - Backup only files being removed
   - Show backup progress

8. File removal logic:
   - Remove files one by one
   - After all files removed, check if directories are empty
   - Only remove empty directories
   - Show "Preserved: [dir] (contains non-gsd-opencode files)" for kept dirs

9. Success message with recovery instructions:
   - Show backup location
   - Show recovery command example
   - Note backup retention period

10. Error handling:
    - Handle missing manifest (fallback mode with warning)
    - Handle permission errors
    - Handle backup failures (log warning but continue)
    - Handle Ctrl+C (AbortPromptError)
</action>
  <verify>
grep -n "ManifestManager\|manifestManager" src/commands/uninstall.js &&
grep -n "isInAllowedNamespace\|ALLOWED_NAMESPACES" src/commands/uninstall.js &&
grep -n "promptTypedConfirmation" src/commands/uninstall.js &&
grep -n "dryRun" src/commands/uninstall.js &&
grep -n "Safety Summary\|Will Preserve" src/commands/uninstall.js
  </verify>
  <done>Uninstall command implements namespace protection, manifest loading, typed confirmation, dry-run, and backup</done>
</task>

<task type="auto">
  <name>Task 6: Register new flags in CLI entry point</name>
  <files>bin/gsd.js</files>
  <action>
Update the uninstall command registration in bin/gsd.js to support new flags.

Changes:
1. Find the uninstall command registration (around line 245-261)
2. Add option: `.option('--dry-run', 'Show what would be removed without removing')`
3. Add option: `.option('--no-backup', 'Skip backup creation before removal')`
4. Ensure options are passed to uninstallCommand in action handler:
   ```javascript
   .action(async (options) => {
     const exitCode = await uninstallCommand({
       global: options.global,
       local: options.local,
       force: options.force,
       verbose: options.verbose,
       dryRun: options.dryRun,
       backup: options.backup  // Commander converts --no-backup to backup: false
     });
     process.exit(exitCode);
   })
   ```

5. Update help text to reflect new safety features
</action>
  <verify>
grep -A15 "command('uninstall')" bin/gsd.js | grep -E "(dry-run|no-backup|backup)"
  </verify>
  <done>--dry-run and --no-backup flags registered and passed to uninstallCommand</done>
</task>

</tasks>

<verification>
1. Manual test: Run `node bin/gsd.js install --local` - verify INSTALLED_FILES.json is created
2. Manual test: Run `node bin/gsd.js uninstall --dry-run --local` - should show preview with categories
3. Manual test: Run `node bin/gsd.js uninstall --local` - should show typed confirmation prompt
4. Verify backup directory is created with timestamped files
5. Verify namespace protection: create a file outside gsd-* namespace, verify it's not removed
6. Verify recovery instructions in success message
</verification>

<success_criteria>
- Install creates INSTALLED_FILES.json manifest with all file paths, sizes, and hashes
- Uninstall loads manifest and only removes files in allowed namespaces (gsd-*)
- Uninstall shows warning with namespace protection notice
- --dry-run flag shows three-category preview (Will Remove/Will Skip/Will Preserve)
- User must type 'uninstall' to confirm (unless --force flag used)
- Backup is created in .uninstall-backups directory before deletion
- Directories containing non-gsd-opencode files are preserved
- Success message includes backup location and recovery instructions
- --no-backup flag allows skipping backup creation
- All existing functionality (scope detection, permission handling) preserved
</success_criteria>

<output>
After completion, create `.planning/phases/07-make-uninstall-safe-and-user-friendly/07-01-SUMMARY.md`
</output>
</planning_context>
