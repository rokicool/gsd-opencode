---
phase: 07-make-uninstall-safe-and-user-friendly
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - test/services/manifest-manager.test.js
  - test/commands/uninstall.test.js
  - test/utils/interactive.test.js
autonomous: true
user_setup: []
must_haves:
  truths:
    - "ManifestManager tests verify file tracking and hash generation"
    - "ManifestManager tests verify namespace filtering"
    - "ManifestManager tests verify manifest persistence"
    - "promptTypedConfirmation tests verify exact word matching"
    - "promptTypedConfirmation tests verify case-insensitive matching"
    - "promptTypedConfirmation tests verify retry logic"
    - "Uninstall dry-run mode tests verify no files are removed"
    - "Uninstall namespace tests verify only gsd-* files are removed"
    - "Uninstall namespace tests verify non-gsd files are preserved"
    - "Uninstall backup tests verify backup creation"
    - "Uninstall confirmation tests verify typed confirmation flow"
  artifacts:
    - path: "test/services/manifest-manager.test.js"
      provides: "Unit tests for ManifestManager"
      contains: ["describe('ManifestManager'"]
    - path: "test/utils/interactive.test.js"
      provides: "Unit tests for promptTypedConfirmation"
      contains: ["describe('promptTypedConfirmation'"]
    - path: "test/commands/uninstall.test.js"
      provides: "Unit tests for enhanced uninstall command"
      contains: ["describe('uninstall'"]
  key_links:
    - from: "test/services/manifest-manager.test.js"
      to: "src/services/manifest-manager.js"
      via: "import { ManifestManager }"
    - from: "test/commands/uninstall.test.js"
      to: "src/commands/uninstall.js"
      via: "import { uninstallCommand }"
---

<objective>
Create comprehensive unit tests for the ManifestManager service, promptTypedConfirmation utility, and enhanced uninstall command with namespace protection.

Purpose: Ensure the manifest-based safety system works correctly and namespace protection prevents accidental data loss.
Output: Unit test suites covering manifest operations, typed confirmation, dry-run mode, namespace filtering, and backup functionality.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/services/manifest-manager.js
@src/commands/uninstall.js
@src/utils/interactive.js
@test/commands/uninstall.test.js (if exists - may need to update)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for ManifestManager</name>
  <files>test/services/manifest-manager.test.js</files>
  <action>
Create comprehensive unit tests for the ManifestManager service.

Test cases to include:

**Constructor and basic operations:**
1. Creates instance with installPath
2. addFile() adds file to internal array
3. save() writes valid JSON to INSTALLED_FILES.json
4. load() reads manifest and returns array
5. load() returns null if manifest doesn't exist

**Hash and size tracking:**
6. addFile() accepts and stores size and hash
7. Manifest JSON has correct structure (path, relativePath, size, hash)

**Namespace filtering:**
8. isInAllowedNamespace() returns true for gsd-* paths:
   - agents/gsd-debugger/SKILL.md → true
   - command/gsd/install.js → true
   - get-shit-done/workflows/execute.md → true
9. isInAllowedNamespace() returns false for non-gsd paths:
   - agents/other-agent/file.md → false
   - command/other/file.js → false
   - config.json → false
10. getFilesInNamespaces() filters files correctly
11. getFilesInNamespaces() returns empty array if no matches

**Edge cases:**
12. Handles empty manifest (no files added)
13. Handles manifest with corrupted JSON (returns null or throws)
14. Handles relative paths correctly

**Mocking:**
- Mock fs/promises for file operations
- Use vi.spyOn for crypto hash generation
- Create temp directories with os.tmpdir() for isolation

Test file structure:
```javascript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { ManifestManager } from '../../src/services/manifest-manager.js';
import fs from 'fs/promises';
import path from 'path';
import os from 'os';

describe('ManifestManager', () => {
  let tempDir;
  let manifestManager;
  
  beforeEach(async () => {
    tempDir = path.join(os.tmpdir(), `manifest-test-${Date.now()}`);
    await fs.mkdir(tempDir, { recursive: true });
    manifestManager = new ManifestManager(tempDir);
  });
  
  afterEach(async () => {
    await fs.rm(tempDir, { recursive: true, force: true });
  });
  
  // ... test cases
});
```
</action>
  <verify>
npm test -- test/services/manifest-manager.test.js 2>&1 | grep -E "(PASS|FAIL|ManifestManager)"
  </verify>
  <done>All ManifestManager tests pass covering namespace filtering and manifest persistence</done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for promptTypedConfirmation</name>
  <files>test/utils/interactive.test.js</files>
  <action>
Create or enhance unit tests for the promptTypedConfirmation function.

Test cases to include:

**Basic functionality:**
1. Returns true when user types correct word (exact match)
2. Returns true when user types correct word with different case (case-insensitive)
3. Returns false when user types incorrect word
4. Returns false after 3 failed attempts

**Input handling:**
5. Returns null when user cancels (AbortPromptError)
6. Handles empty string input (counts as failure)
7. Handles whitespace-only input (counts as failure)
8. Shows error message on incorrect input

**Retry logic:**
9. Shows retry prompt after incorrect input
10. Allows exactly 3 attempts before giving up
11. Returns true on successful attempt before hitting limit

**Mocking:**
- Mock @inquirer/prompts input function
- Mock should return different values on consecutive calls
- Test with: ['wrong', 'WRONG', 'uninstall'] → should return true on 3rd try

If test file doesn't exist:
1. Create it following existing test patterns
2. Add describe block for promptTypedConfirmation

If file exists:
1. Add new describe block for promptTypedConfirmation
2. Keep existing tests for other functions
</action>
  <verify>
npm test -- test/utils/interactive.test.js 2>&1 | grep -E "(PASS|FAIL|promptTypedConfirmation)"
  </verify>
  <done>All promptTypedConfirmation tests pass with comprehensive coverage of retry logic</done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for enhanced uninstall command</name>
  <files>test/commands/uninstall.test.js</files>
  <action>
Create comprehensive unit tests for the enhanced uninstall command with namespace protection.

**Test fixtures setup:**
Create test/fixtures/uninstall/ directory with:
1. Sample installation structure:
   ```
   test-install/
   ├── INSTALLED_FILES.json (manifest)
   ├── VERSION
   ├── agents/
   │   ├── gsd-debugger/
   │   │   └── SKILL.md (allowed - should be removed)
   │   └── other-agent/
   │       └── file.md (NOT allowed - should be preserved)
   ├── command/
   │   └── gsd/
   │       └── install.js (allowed - should be removed)
   └── config.json (NOT in manifest - should be preserved)
   ```

2. Create manifest.json fixture with entries for allowed files only

**Test cases to include:**

**Manifest loading tests:**
1. Loads manifest if exists and uses it for file list
2. Falls back to namespace patterns if manifest missing
3. Shows warning when using fallback mode

**Namespace protection tests:**
4. Only removes files in allowed namespaces (gsd-*)
5. Preserves files outside allowed namespaces
6. Preserves directories that contain non-gsd files
7. Shows "Will Preserve" category for non-namespace files

**Dry-run mode tests:**
8. --dry-run shows preview without removing files
9. --dry-run displays three categories (Will Remove/Will Skip/Will Preserve)
10. --dry-run shows file counts and sizes
11. --dry-run exits with code 0

**Backup tests:**
12. Creates backup directory before removal
13. Backs up only files being removed
14. Backup contains date-stamped files
15. --no-backup skips backup creation
16. Continues uninstall if backup fails (with warning)

**Typed confirmation tests:**
17. Requires typing 'uninstall' to proceed
18. Case-insensitive confirmation works
19. --force flag skips typed confirmation
20. Incorrect input shows error and retries

**Safety summary tests:**
21. Shows Safety Summary with accurate counts
22. Shows correct number of preserved directories
23. Shows backup location

**Directory cleanup tests:**
24. Removes empty directories after file removal
25. Preserves non-empty directories
26. Shows message for preserved directories

**Success message tests:**
27. Shows backup location in success message
28. Shows recovery instructions

**Error handling tests:**
29. Handles missing installation gracefully
30. Handles permission errors
31. Handles Ctrl+C (AbortPromptError) with exit code 130

**Mocking strategy:**
- Mock @inquirer/prompts for typed confirmation
- Mock fs/promises for file operations
- Mock BackupManager for backup tests
- Mock logger to capture output assertions
- Use vi.spyOn for ManifestManager methods

**Test structure:**
```javascript
describe('uninstall command with safety features', () => {
  let tempInstallDir;
  
  beforeEach(async () => {
    // Create temp directory with test installation
  });
  
  afterEach(async () => {
    // Cleanup temp directory
  });
  
  describe('namespace protection', () => { /* ... */ });
  describe('dry-run mode', () => { /* ... */ });
  describe('backup creation', () => { /* ... */ });
  describe('typed confirmation', () => { /* ... */ });
});
```
</action>
  <verify>
npm test -- test/commands/uninstall.test.js 2>&1 | grep -E "(PASS|FAIL|Test Files)"
  </verify>
  <done>All uninstall tests pass covering namespace protection, dry-run, backup, and typed confirmation</done>
</task>

</tasks>

<verification>
1. Run `npm test` - all new tests should pass
2. Run `npm test -- --coverage` - check coverage for new code
3. Verify coverage for ManifestManager >90%
4. Verify coverage for enhanced uninstall >80%
5. Verify no regressions in existing tests
</verification>

<success_criteria>
- ManifestManager has 14+ test cases covering all methods
- promptTypedConfirmation has 10+ test cases covering retry logic
- Uninstall command has 30+ test cases covering all safety features
- All tests pass with npm test
- Test coverage for new functionality is >80%
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/07-make-uninstall-safe-and-user-friendly/07-02-SUMMARY.md`
</output>
</planning_context>
