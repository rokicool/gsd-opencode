---
phase: 04-agent-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd-opencode/get-shit-done/lib/agents.md
autonomous: true

must_haves:
  truths:
    - "Stage-to-agent mapping covers all 11 GSD agents correctly"
    - "Missing agent files produce clear error listing what's missing"
    - "All agents are validated before any are modified (batch validation)"
    - "Validation catches malformed frontmatter before attempted modification"
  artifacts:
    - path: "gsd-opencode/get-shit-done/lib/agents.md"
      provides: "Agent discovery and validation library"
      contains: "resolveAgentPath"
      exports: ["resolveAgentPath", "validateAgentsExist", "parseFrontmatter", "validateFrontmatter", "getValidModels", "validateAllAgents"]
  key_links:
    - from: "gsd-opencode/get-shit-done/lib/agents.md"
      to: "gsd-opencode/get-shit-done/lib/config.md"
      via: "imports getAgentsForStage()"
      pattern: "@.*config\\.md"
    - from: "validateModelKey()"
      to: "opencode models"
      via: "shell command execution"
      pattern: "opencode models"
---

<objective>
Create agent discovery and validation library for Phase 5's frontmatter rewriting.

Purpose: Establish infrastructure to locate, parse, and validate all 11 GSD agents before any modification. Phase 5 will consume these procedures to safely rewrite frontmatter.

Output: `gsd-opencode/get-shit-done/lib/agents.md` — an @-referenceable library with pseudocode procedures following the config.md pattern.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-agent-discovery/04-CONTEXT.md
@gsd-opencode/get-shit-done/lib/config.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent Resolution and Existence Validation</name>
  <files>gsd-opencode/get-shit-done/lib/agents.md</files>
  <action>
Create a new markdown library file at `gsd-opencode/get-shit-done/lib/agents.md` following the config.md pattern (pseudocode procedures, @-referenceable).

Include:

**Header section:**
- Purpose: Agent discovery and validation for frontmatter rewriting
- References config.md for stage-to-agent mapping via @-reference

**Constants:**
- `AGENTS_DIR`: Path to agents directory (`gsd-opencode/agents/`)
- `ALL_GSD_AGENTS`: List of all 11 GSD agent names (from config.md's getAgentsForStage mapping)
  - planning: gsd-planner, gsd-plan-checker, gsd-phase-researcher, gsd-roadmapper, gsd-project-researcher, gsd-research-synthesizer, gsd-codebase-mapper
  - execution: gsd-executor, gsd-debugger
  - verification: gsd-verifier, gsd-integration-checker

**Procedures:**

1. `resolveAgentPath(agentName)`:
   - Returns absolute path: `${AGENTS_DIR}/${agentName}.md`
   - No validation here (that's separate)

2. `validateAgentsExist()`:
   - Iterate ALL_GSD_AGENTS
   - Check each file exists via resolveAgentPath()
   - Collect all missing files (batch, not fail-fast)
   - Return `{ valid: true }` or `{ valid: false, missing: string[], error: string }`
   - Error format: "Missing agent files:\n  - gsd-planner.md\n  - gsd-verifier.md\nExpected at: gsd-opencode/agents/"

Use 2-space indented pseudocode (TypeScript-like) matching config.md style.
  </action>
  <verify>
File exists at `gsd-opencode/get-shit-done/lib/agents.md` with:
- Header section with purpose and @-reference to config.md
- AGENTS_DIR constant
- ALL_GSD_AGENTS constant listing all 11 agents
- resolveAgentPath() procedure
- validateAgentsExist() procedure with batch error collection
  </verify>
  <done>
Agent path resolution and existence validation procedures documented. Missing agents produce clear, batched error listing all missing files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontmatter Parsing and Model Validation</name>
  <files>gsd-opencode/get-shit-done/lib/agents.md</files>
  <action>
Add frontmatter parsing and model validation procedures to agents.md:

**Procedures:**

1. `parseFrontmatter(agentPath)`:
   - Read file content
   - Extract YAML between first `---` markers
   - Parse YAML to object
   - Return `{ ok: true, frontmatter: object, bodyStart: number }` or `{ ok: false, error: string }`
   - Error cases:
     - File not found: "Agent file not found: {path}"
     - No frontmatter: "No frontmatter found in: {path}"
     - Invalid YAML: "Invalid YAML in frontmatter: {path} - {yamlError}"

2. `validateFrontmatter(frontmatter, agentPath)`:
   - Check required keys: name (string), description (string), tools (object)
   - If `model` key exists:
     - Must be non-empty string (not null, not empty, correct type)
     - If invalid type/empty: return error
   - Return `{ valid: true }` or `{ valid: false, errors: string[] }`
   - Note: Model value validation against opencode models is separate

3. `getValidModels()`:
   - Run `opencode models` command
   - Parse output to extract model identifiers (provider/model format, e.g., "opencode/claude-sonnet-4")
   - Return `{ ok: true, models: string[] }` or `{ ok: false, error: string }`
   - Handle command failure gracefully

4. `validateModelKey(modelValue, validModels)`:
   - Check modelValue exists in validModels array
   - Return `{ valid: true }` or `{ valid: false, error: "Invalid model 'X'. Run 'opencode models' to see valid options." }`

Include a note that model key is optional — agents without it inherit OpenCode's current model selection.
  </action>
  <verify>
agents.md now includes:
- parseFrontmatter() with YAML extraction and error handling
- validateFrontmatter() checking required keys and optional model format
- getValidModels() running opencode models command
- validateModelKey() checking against valid models
- Documentation note that model key is optional
  </verify>
  <done>
Frontmatter parsing and model validation procedures documented. Handles both structural validation and optional model key validation against live opencode models output.
  </done>
</task>

<task type="auto">
  <name>Task 3: Batch Validation Orchestration</name>
  <files>gsd-opencode/get-shit-done/lib/agents.md</files>
  <action>
Add the main orchestration procedure that Phase 5 will call:

**Procedure:**

`validateAllAgents()`:
   - Purpose: Batch validate all agents before any modification
   - Steps:
     1. Call validateAgentsExist() — fail early if files missing
     2. Get valid models via getValidModels()
     3. For each agent in ALL_GSD_AGENTS:
        - parseFrontmatter(resolveAgentPath(agent))
        - validateFrontmatter(frontmatter, path)
        - If model key exists, validateModelKey(model, validModels)
        - Collect all errors (batch, not fail-fast)
     4. Return aggregate result:
        - `{ valid: true, agents: AgentInfo[] }` with parsed frontmatter for each agent
        - `{ valid: false, errors: ValidationError[] }` with all errors

   - AgentInfo structure: `{ name, path, frontmatter, bodyStart }`
   - ValidationError structure: `{ agent, path, errors: string[] }`

**Usage section:**
Add usage examples showing how Phase 5 will call this:

```ts
const result = validateAllAgents();
if (!result.valid) {
  // Display all errors, abort before any modification
  for (const err of result.errors) {
    console.error(`${err.agent}: ${err.errors.join(", ")}`);
  }
  return;
}
// Safe to proceed with frontmatter rewriting
for (const agent of result.agents) {
  // agent.frontmatter, agent.bodyStart available
}
```

Document the batch validation guarantee: "All agents are validated before any are modified."
  </action>
  <verify>
agents.md now includes:
- validateAllAgents() orchestration procedure
- AgentInfo and ValidationError type documentation
- Usage section with Phase 5 consumption example
- Batch validation guarantee documented
  </verify>
  <done>
Batch validation orchestration complete. Phase 5 can call validateAllAgents() to get pre-validated agent info or aggregated errors before any modification.
  </done>
</task>

</tasks>

<verification>
## Phase Verification

1. **AGNT-02 (Stage-to-agent mapping):** ALL_GSD_AGENTS constant lists all 11 agents matching config.md's getAgentsForStage() mapping

2. **AGNT-03 (Missing agent errors):** validateAgentsExist() collects all missing files and produces clear error: "Missing agent files:\n  - agent1.md\n  - agent2.md"

3. **AGNT-04 (Batch validation):** validateAllAgents() validates ALL agents before returning, collecting errors rather than failing fast

4. **Malformed frontmatter detection:** parseFrontmatter() and validateFrontmatter() catch YAML errors and structural issues

Run manual check:
- Count agents in ALL_GSD_AGENTS (should be 11)
- Verify each procedure has error handling
- Verify validateAllAgents() collects errors before returning
</verification>

<success_criteria>
- [ ] agents.md exists at gsd-opencode/get-shit-done/lib/agents.md
- [ ] ALL_GSD_AGENTS lists exactly 11 agents (not 12 — excludes gsd-set-profile)
- [ ] resolveAgentPath(), validateAgentsExist() documented
- [ ] parseFrontmatter(), validateFrontmatter() documented
- [ ] getValidModels(), validateModelKey() documented  
- [ ] validateAllAgents() orchestrates batch validation
- [ ] Error messages are clear and actionable
- [ ] Usage section shows Phase 5 consumption pattern
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-discovery/04-01-SUMMARY.md` following the summary template.
</output>
