---
phase: 05-frontmatter-rewriting
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd-opencode/get-shit-done/lib/config.md
  - gsd-opencode/get-shit-done/lib/agents.md
  - gsd-opencode/agents/gsd-set-profile.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Per-stage overrides stored at profiles.custom_overrides.{stage} affect the stage→model mapping used for agent frontmatter rewriting"
    - "After confirming /gsd-set-profile (including the Edit flow), agent rewrites use the effective stage models (preset + overrides)"
    - "User-facing tables in gsd-set-profile show the effective stage models (preset + overrides), not just raw preset values"
  artifacts:
    - path: "gsd-opencode/get-shit-done/lib/config.md"
      provides: "A helper to compute effective stage models by overlaying profiles.custom_overrides onto a preset"
      contains: "getEffectiveStageModels"
    - path: "gsd-opencode/get-shit-done/lib/agents.md"
      provides: "applyProfile() uses effective stage models when rewriting agent frontmatter"
      contains: "getEffectiveStageModels"
    - path: "gsd-opencode/agents/gsd-set-profile.md"
      provides: "Confirmation flow persists overrides before applying the profile; tables reflect effective configuration"
      contains: "getEffectiveStageModels"
  key_links:
    - from: "gsd-opencode/get-shit-done/lib/agents.md"
      to: "gsd-opencode/get-shit-done/lib/config.md"
      via: "applyProfile() uses getEffectiveStageModels()"
      pattern: "getEffectiveStageModels\("
    - from: "gsd-opencode/get-shit-done/lib/config.md"
      to: "profiles.custom_overrides"
      via: "overlay custom_overrides onto preset stage mapping"
      pattern: "custom_overrides"
    - from: "gsd-opencode/agents/gsd-set-profile.md"
      to: "applyProfile()"
      via: "persist overrides, then call applyProfile(newProfile)"
      pattern: "applyProfile\(newProfile\)"
---

<objective>
Close Phase 5 verification gap: ensure per-stage overrides (profiles.custom_overrides.*) are applied when rewriting agent frontmatter.

Purpose: PROF-02 requires that user-edited per-stage model overrides take effect immediately in OpenCode via agent frontmatter rewriting.
Output: Updated prompt-libraries (config.md, agents.md, gsd-set-profile.md) so profile application uses the effective stage models (preset + overrides).
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Gap report driving this plan
@.planning/phases/05-frontmatter-rewriting/05-frontmatter-rewriting-VERIFICATION.md

# Phase context / decisions
@.planning/phases/05-frontmatter-rewriting/05-CONTEXT.md

# Libraries/commands to edit
@gsd-opencode/get-shit-done/lib/config.md
@gsd-opencode/get-shit-done/lib/agents.md
@gsd-opencode/agents/gsd-set-profile.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add "effective stage models" helper (preset + overrides)</name>
  <files>gsd-opencode/get-shit-done/lib/config.md</files>
  <action>
Add a new procedure to config.md:

### getEffectiveStageModels(presetName)

Goal: return the stage→model mapping that should actually be used at runtime when rewriting agent frontmatter.

Behavior requirements:
- Validate presetName via validateProfile() (same as getPresetConfig)
- Read config via readConfig()
- Start with the preset mapping (using getPresetConfig(presetName) or equivalent inline logic)
- Overlay `config.profiles.custom_overrides` ON TOP of that mapping
  - Only apply overrides for known stages: `planning | execution | verification`
  - Only apply override values that are non-empty strings
  - Ignore any unknown keys in custom_overrides
- Return `{ ok: true, stageModels: { planning, execution, verification } }` on success
- Return `{ ok: false, error }` with clear message on validation/config errors

Documentation requirements:
- Explicitly state: getPresetConfig() returns the raw preset mapping and does NOT apply overrides.
- Add a short usage note: use getEffectiveStageModels() anywhere you need the models that will actually be applied.
  </action>
  <verify>
Run:
- `rg -n "getEffectiveStageModels" gsd-opencode/get-shit-done/lib/config.md`

Confirm config.md now includes:
- A section header for getEffectiveStageModels
- Pseudocode that reads profiles.custom_overrides and overlays it onto the preset mapping
  </verify>
  <done>
config.md documents getEffectiveStageModels(presetName) and makes it the canonical way to compute stage models when overrides exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update applyProfile() to use effective stage models (includes overrides)</name>
  <files>gsd-opencode/get-shit-done/lib/agents.md</files>
  <action>
In agents.md, update the applyProfile(presetName) procedure so it uses the effective stage models (preset + overrides), not just raw presets.

Implementation requirements (pseudocode-level):
- Replace the call to `getPresetConfig(presetName)` with `getEffectiveStageModels(presetName)` (from config.md)
- Use the returned mapping as `stageModels` for stage-by-stage rewriting
- Update the surrounding explanatory text to mention:
  - Overrides live under `profiles.custom_overrides.{stage}`
  - applyProfile applies them automatically by using getEffectiveStageModels

Compatibility requirements:
- Preserve existing validation-first behavior (validate preset name; validateAllAgents before any writes)
- Preserve idempotency check (currentModel === stageModel → unchanged)
- Preserve fail-fast on first write error with partial success reporting
  </action>
  <verify>
Run:
- `rg -n "getEffectiveStageModels" gsd-opencode/get-shit-done/lib/agents.md`
- `rg -n "getPresetConfig\(presetName\)" gsd-opencode/get-shit-done/lib/agents.md` and confirm applyProfile no longer uses it

Confirm applyProfile pseudocode now:
- Calls getEffectiveStageModels(presetName)
- Uses that mapping to choose stageModel per stage
  </verify>
  <done>
agents.md applyProfile() is wired to apply overrides by using the effective stage models mapping.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire gsd-set-profile UX + ordering so overrides take effect immediately</name>
  <files>gsd-opencode/agents/gsd-set-profile.md</files>
  <action>
Update gsd-set-profile.md so both the UX preview and the actual apply step reflect per-stage overrides.

Changes to make:

1) Preview tables (before confirm):
- Replace `getPresetConfig(currentProfile)` and `getPresetConfig(newProfile)` with `getEffectiveStageModels(currentProfile)` and `getEffectiveStageModels(newProfile)`.
- Label the table as "effective" (or otherwise clarify it includes overrides).

2) Final "Current configuration" table:
- Replace `getPresetConfig(newProfile)` with `getEffectiveStageModels(newProfile)` so it shows the effective models OpenCode will actually use.

3) Confirm-after-edit ordering (critical wiring):
- Ensure the documented flow persists overrides to config BEFORE invoking applyProfile(newProfile).
  - Either: combine into a single writeConfig() overlay that includes both `profiles.active_profile` and `profiles.custom_overrides`, then call applyProfile(newProfile)
  - Or: if keeping `setActiveProfile(newProfile)` + `writeConfig(overrides)` as separate calls, explicitly document that applyProfile must be called AFTER both have succeeded.

4) Minimal override writes:
- Keep the existing rule: only write override keys for stages the user changed.
- If the user changed none of the stages, do not write overrides.

Do NOT add new features beyond wiring and clarity; keep changes constrained to closing the verification gap.
  </action>
  <verify>
Run:
- `rg -n "getPresetConfig\(" gsd-opencode/agents/gsd-set-profile.md` and confirm preview + final table no longer use getPresetConfig
- `rg -n "getEffectiveStageModels" gsd-opencode/agents/gsd-set-profile.md` and confirm it is used in:
  - the confirmation preview table
  - the final configuration table
  - (if applicable) edit/confirm text

Manual read-through check:
- Confirm-after-edit section explicitly persists overrides before applyProfile(newProfile)
  </verify>
  <done>
gsd-set-profile.md documents a flow where edited per-stage overrides are persisted and then immediately applied to agent frontmatter rewriting via applyProfile().
  </done>
</task>

</tasks>

<verification>
1) Gap closure checklist (from 05-frontmatter-rewriting-VERIFICATION.md):
- A config helper exists that returns effective stage models (preset + custom_overrides)
- applyProfile uses the effective stage models when rewriting agent frontmatter
- gsd-set-profile confirm flow applies edited mapping to rewriting by ensuring overrides are persisted before applyProfile

2) Wiring sanity:
- agents.md references config.md for getEffectiveStageModels()
- gsd-set-profile.md references agents.md and uses getEffectiveStageModels() for tables
</verification>

<success_criteria>
- The Phase 5 failed truth is now achievable: per-stage overrides apply correct model to each stage’s agents.
- PROF-02 is unblocked at the design/prompt-library level: overrides are not just stored, they affect the mapping used for rewriting.
- No regression to Phase 5 verified behaviors: rewrite preservation/idempotency/fail-fast orchestration remain intact.
</success_criteria>

<output>
After completion, create `.planning/phases/05-frontmatter-rewriting/05-02-SUMMARY.md`
</output>
