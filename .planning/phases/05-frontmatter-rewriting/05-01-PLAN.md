---
phase: 05-frontmatter-rewriting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd-opencode/get-shit-done/lib/agents.md
  - gsd-opencode/agents/gsd-set-profile.md
autonomous: true

must_haves:
  truths:
    - "Changing profile rewrites model: frontmatter in all 11 agent files"
    - "Per-stage overrides apply correct model to each stage's agents"
    - "Frontmatter rewriting preserves all other keys and body content"
    - "Rewriting is idempotent (same profile twice = same result)"
  artifacts:
    - path: "gsd-opencode/get-shit-done/lib/agents.md"
      provides: "rewriteFrontmatter() and applyProfile() procedures"
      contains: "function rewriteFrontmatter"
    - path: "gsd-opencode/agents/gsd-set-profile.md"
      provides: "Profile application after confirmation"
      contains: "applyProfile"
  key_links:
    - from: "gsd-set-profile.md"
      to: "agents.md"
      via: "@-reference and applyProfile() call"
      pattern: "@gsd-opencode/get-shit-done/lib/agents.md"
    - from: "applyProfile()"
      to: "getPresetConfig()"
      via: "config.md lookup"
      pattern: "getPresetConfig"
    - from: "applyProfile()"
      to: "validateAllAgents()"
      via: "pre-validation"
      pattern: "validateAllAgents"
---

<objective>
Implement frontmatter rewriting so profile changes update the `model:` key in all agent files.

Purpose: This is the mechanism that makes profile changes take effect — OpenCode reads model from agent frontmatter, so rewriting is required.

Output: 
- agents.md extended with `rewriteFrontmatter()` and `applyProfile()` procedures
- gsd-set-profile.md updated to call `applyProfile()` after user confirms
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work this plan builds on
@.planning/phases/04-agent-discovery/04-01-SUMMARY.md

# Libraries to extend/reference
@gsd-opencode/get-shit-done/lib/agents.md
@gsd-opencode/get-shit-done/lib/config.md

# Command to update
@gsd-opencode/agents/gsd-set-profile.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Frontmatter Rewriting Procedures</name>
  <files>gsd-opencode/get-shit-done/lib/agents.md</files>
  <action>
Add two new procedures to agents.md:

**serializeFrontmatter(frontmatter, originalLines, bodyStart):**
- Takes the modified frontmatter object and original file lines
- Rebuilds the frontmatter YAML while preserving:
  - Original key ordering (except model: which goes at top after name)
  - Existing values for non-model keys
  - Body content starting at bodyStart
- Insert model key if it didn't exist
- Return the complete file content as string

Key implementation notes:
- Use simple key: value serialization (no YAML library needed for flat frontmatter)
- Handle multi-line values for `description` (use pipe | if > 80 chars, or wrap in quotes)
- Preserve `tools:` block exactly as-is (read lines between tools: and next key, copy verbatim)
- Handle `color:` key if present

**rewriteFrontmatter(agentInfo, newModel):**
- Input: AgentInfo from validateAllAgents(), new model string
- Read original file content
- Create modified frontmatter with model key updated/inserted
- Call serializeFrontmatter() to rebuild file
- Write file back to disk
- Return: `{ ok: true }` or `{ ok: false, error: string }`

Key implementation notes:
- agentInfo.frontmatter already has parsed data
- agentInfo.bodyStart tells where body content begins
- If write fails, return error immediately (fail fast per CONTEXT.md decision)
  </action>
  <verify>
The procedures are documented in agents.md with pseudocode following the existing pattern.
Verify the serialization logic handles:
- Inserting model key when missing
- Updating model key when present
- Preserving tools: block (multi-line YAML)
- Preserving body content after frontmatter
  </verify>
  <done>
agents.md contains serializeFrontmatter() and rewriteFrontmatter() procedures with complete pseudocode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Profile Application Orchestration</name>
  <files>gsd-opencode/get-shit-done/lib/agents.md</files>
  <action>
Add `applyProfile(presetName)` procedure to agents.md:

**applyProfile(presetName):**

1. Validate preset name via `validateProfile()` from config.md
2. Call `validateAllAgents()` — abort if any validation errors
3. Call `getPresetConfig(presetName)` to get stage-to-model mappings
4. For each stage (planning, execution, verification):
   - Get model for this stage from preset config
   - Get agents for this stage via `getAgentsForStage()`
   - For each agent in stage:
     - Find matching AgentInfo from validation result
     - Call `rewriteFrontmatter(agentInfo, stageModel)`
     - If write fails: stop immediately, report which agents succeeded and which failed
5. Return success with summary of changes

**Return type:**
- `{ ok: true, modified: string[], unchanged: string[] }` on success
  - `modified`: agent names where model was changed
  - `unchanged`: agent names where model was already correct (idempotency)
- `{ ok: false, error: string, succeeded: string[], failed: string }` on failure
  - `succeeded`: agents that were written before failure
  - `failed`: agent that caused the failure

**Idempotency check:**
Before rewriting, compare new model to existing model. If identical, skip rewrite and add to `unchanged` list.
This satisfies success criteria #4.
  </action>
  <verify>
The procedure is documented in agents.md with pseudocode.
Verify the orchestration:
- Validates before any modification
- Gets correct model per stage
- Reports modified vs unchanged agents
- Handles partial failure gracefully
  </verify>
  <done>
agents.md contains applyProfile() procedure with complete orchestration logic and idempotency support.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate with gsd-set-profile</name>
  <files>gsd-opencode/agents/gsd-set-profile.md</files>
  <action>
Update gsd-set-profile.md to call applyProfile() after user confirms:

1. Add @-reference to agents.md at top of context section:
   ```
   @gsd-opencode/get-shit-done/lib/agents.md
   ```

2. Update the confirmation flow (after user types "yes" or confirms):
   - Call `applyProfile(selectedProfile)`
   - If ok:
     - Display success message with modified/unchanged counts
     - Show list of modified agents grouped by stage
   - If error:
     - Display error message
     - Show which agents succeeded (if any) and which failed
     - Suggest: "You can re-run the command to retry. Git can restore any modified files."

3. Update the "Show proposed changes" section to include agent file changes:
   - Current: Shows stage → model mappings
   - Add: "This will update the model: key in all 11 agent files"

4. Ensure idempotency message is shown when all agents unchanged:
   - "All agents already have the correct model configured."
  </action>
  <verify>
Read gsd-set-profile.md and verify:
- agents.md is referenced in context section
- applyProfile() is called after confirmation
- Success/failure messages are documented
- Idempotency case is handled
  </verify>
  <done>
gsd-set-profile command applies profile changes to agent files after user confirmation.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Library completeness:**
   - agents.md exports: rewriteFrontmatter, serializeFrontmatter, applyProfile (in addition to existing procedures)
   - All procedures have pseudocode and example scenarios

2. **Command integration:**
   - gsd-set-profile.md references agents.md
   - Confirmation flow includes applyProfile() call
   - Error handling documented

3. **Success criteria check:**
   - [x] Changing profile rewrites model: frontmatter → applyProfile() orchestrates this
   - [x] Per-stage overrides apply correct model → getPresetConfig() + getAgentsForStage() integration
   - [x] Preserves other keys and body → serializeFrontmatter() logic
   - [x] Idempotent → unchanged tracking in applyProfile()
</verification>

<success_criteria>
- agents.md contains 3 new procedures: serializeFrontmatter, rewriteFrontmatter, applyProfile
- gsd-set-profile.md calls applyProfile after confirmation
- Profile application is atomic (validate all first, then write)
- Idempotency: running same profile twice shows "all agents unchanged"
- Failure recovery: partial success is reported, git can restore
</success_criteria>

<output>
After completion, create `.planning/phases/05-frontmatter-rewriting/05-01-SUMMARY.md`
</output>
