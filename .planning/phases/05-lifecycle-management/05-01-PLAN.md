---
phase: 05-lifecycle-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/npm-registry.js
autonomous: true

must_haves:
  truths:
    - "Can query npm registry for latest version of gsd-opencode"
    - "Can query npm registry for latest version of @rokicool/gsd-opencode"
    - "Can fetch all available versions of a package"
    - "Can get specific version information from npm"
  artifacts:
    - path: "src/utils/npm-registry.js"
      provides: "NPM registry query utility with version fetching"
      exports: ["NpmRegistry"]
  key_links:
    - from: "NpmRegistry.getLatestVersion()"
      to: "npm view <package> version"
      via: "child_process.exec"
    - from: "NpmRegistry.getAllVersions()"
      to: "npm view <package> versions --json"
      via: "child_process.exec"
---

<objective>
Create NpmRegistry utility class for querying npm registry versions.

Purpose: Provides a clean abstraction for fetching package version information from npm registry, supporting both public gsd-opencode and scoped @rokicool/gsd-opencode packages. This utility is the foundation for the update command's version checking capabilities.

Output: src/utils/npm-registry.js with NpmRegistry class
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/utils/logger.js
@lib/constants.js

# Research findings:
# - NPM registry can be queried via `npm view <package> version` for latest
# - `npm view <package> versions --json` returns all versions
# - Both public (gsd-opencode) and scoped (@rokicool/gsd-opencode) packages supported
# - Current latest: gsd-opencode@1.9.2, Beta: @rokicool/gsd-opencode@1.9.2-dev-8a05
</context>

<tasks>

<task type="auto">
  <name>Create NpmRegistry utility class</name>
  <files>src/utils/npm-registry.js</files>
  <action>
    Create src/utils/npm-registry.js with a NpmRegistry class that provides npm registry querying capabilities:

    1. Class structure:
       - Constructor takes optional logger dependency (defaults to console)
       - All methods are async
       - Uses child_process.exec for npm commands

    2. Methods to implement:
       - `getLatestVersion(packageName)` - Returns latest version string
         * Execute: `npm view ${packageName} version`
         * Parse stdout to extract version (trimmed)
         * Handle errors gracefully (return null with logged error)
         * Support both public and scoped packages

       - `getAllVersions(packageName)` - Returns array of all versions
         * Execute: `npm view ${packageName} versions --json`
         * Parse JSON response
         * Return array of version strings (newest first)
         * Handle errors gracefully (return empty array with logged error)

       - `versionExists(packageName, version)` - Check if version exists
         * Use getAllVersions or check specific version
         * Return boolean

       - `compareVersions(v1, v2)` - Compare two version strings
         * Split by dots, compare numeric components
         * Return -1 if v1 < v2, 0 if equal, 1 if v1 > v2
         * Handle pre-release versions (e.g., 1.9.2-dev-8a05 < 1.9.2)

    3. Error handling:
       - Handle npm not found errors
       - Handle network errors
       - Handle package not found errors
       - All errors logged, methods return safe defaults (null/[])

    4. Package name handling:
       - Support both 'gsd-opencode' and '@rokicool/gsd-opencode'
       - Validate package names to prevent injection
       - Use shell escaping for package names

    5. Include JSDoc documentation for all public methods
    6. Export NpmRegistry class as named export
    7. Add default export with NpmRegistry

    Follow the pattern of other utility modules in src/utils/ (see logger.js for structure reference).
    Keep code focused and single-purpose - this module only handles npm registry queries.
  </action>
  <verify>
    node -e "
      import { NpmRegistry } from './src/utils/npm-registry.js';
      const npm = new NpmRegistry();
      npm.getLatestVersion('gsd-opencode').then(v => console.log('Latest public:', v));
      npm.getAllVersions('gsd-opencode').then(v => console.log('Versions count:', v.length));
    "
  </verify>
  <done>NpmRegistry class exists with getLatestVersion, getAllVersions, versionExists, compareVersions methods; all return proper data types and handle errors gracefully</done>
</task>

</tasks>

<verification>
1. NpmRegistry class can be imported without errors
2. getLatestVersion('gsd-opencode') returns a version string (e.g., '1.9.2') or null on error
3. getLatestVersion('@rokicool/gsd-opencode') returns version for scoped package
4. getAllVersions returns array of version strings
5. versionExists correctly checks version availability
6. compareVersions correctly compares semantic versions
7. All methods have proper JSDoc documentation
</verification>

<success_criteria>
- src/utils/npm-registry.js exists with NpmRegistry class
- Can query latest version for both public and scoped packages
- Can fetch all versions for a package
- Version comparison works correctly
- Error handling prevents crashes
- Code follows existing project patterns and conventions
</success_criteria>

<output>
After completion, create `.planning/phases/05-lifecycle-management/05-01-SUMMARY.md`
</output>
