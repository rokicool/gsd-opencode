---
phase: 05-lifecycle-management
plan: 03
type: execute
wave: 3
depends_on:
  - 05-02
files_modified:
  - src/commands/update.js
  - bin/gsd.js
autonomous: true

must_haves:
  truths:
    - "User can run 'gsd-opencode update' to check and update to latest"
    - "User can run 'gsd-opencode update --beta' to install from @rokicool/gsd-opencode"
    - "User can run 'gsd-opencode update 2.0.0' to install specific version"
    - "Update shows current vs target version before proceeding"
    - "Update prompts for confirmation before making changes"
    - "Update preserves installation scope (global stays global, local stays local)"
    - "Update shows progress during installation"
    - "Update handles 'already up to date' gracefully"
    - "After update, user can verify with 'gsd-opencode list'"
  artifacts:
    - path: "src/commands/update.js"
      provides: "Update command handler"
      exports: ["updateCommand"]
    - path: "bin/gsd.js"
      provides: "CLI registration for update command"
      modification: "Register update command with --beta flag and version argument"
  key_links:
    - from: "update.js updateCommand()"
      to: "UpdateService.checkForUpdate()"
      via: "service method call"
    - from: "update.js updateCommand()"
      to: "UpdateService.performUpdate()"
      via: "service method call after confirmation"
    - from: "bin/gsd.js"
      to: "updateCommand"
      via: "Commander.js action handler"
---

<objective>
Create update command handler and register it in the CLI.

Purpose: Provides the user-facing `gsd-opencode update` command that orchestrates the update process: checking versions, displaying comparison, confirming with user, performing update with progress, and showing results. Supports --beta flag for private registry and optional version argument.

Output: src/commands/update.js and updated bin/gsd.js
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/commands/repair.js
@src/commands/install.js
@src/services/update-service.js
@src/services/scope-manager.js
@src/services/backup-manager.js
@src/services/file-ops.js
@src/utils/npm-registry.js
@src/utils/interactive.js
@src/utils/logger.js
@bin/gsd.js
@lib/constants.js

# From repair.js:
# - Command function structure with options parsing
# - Scope detection (global/local/both)
# - Interactive confirmation with promptConfirmation
# - Progress indication with ora spinner
# - Formatted output using logger
# - Error handling with specific exit codes

# From install.js:
# - Version reading from package.json
# - Success/failure messages
# - Next step suggestions
</context>

<tasks>

<task type="auto">
  <name>Create update command handler</name>
  <files>src/commands/update.js</files>
  <action>
    Create src/commands/update.js following patterns from repair.js and install.js:

    1. Imports:
       - UpdateService from '../services/update-service.js'
       - ScopeManager, BackupManager, FileOperations
       - NpmRegistry from '../utils/npm-registry.js'
       - promptConfirmation from '../utils/interactive.js'
       - logger, setVerbose from '../utils/logger.js'
       - ERROR_CODES from '../../lib/constants.js'
       - fs, path, fileURLToPath for package.json reading
       - ora for progress indication

    2. Helper function `getPackageVersion()`:
       - Copy from repair.js (reads package.json for expected version)

    3. Helper function `displayUpdateInfo(current, target, scopeLabel)`:
       - Show formatted update information
       - Display current version (or 'Not installed')
       - Display target version
       - Show scope (Global/Local)
       - Use logger.heading, logger.info, logger.dim

    4. Helper function `displayUpdateResults(result, scopeLabel)`:
       - Show success/failure status
       - Display backup location
       - Show next steps (run 'gsd-opencode check' to verify)

    5. Main `updateCommand(options)` function:
       - Parameters: options object with { global?, local?, beta?, verbose?, version?, force? }
       - Set verbose mode
       - Show heading: 'GSD-OpenCode Update'

       - Determine scopes to check (like repair.js):
         * If options.global: ['global']
         * If options.local: ['local']
         * Else: ['global', 'local']

       - For each scope:
         * Create ScopeManager
         * Check if installed (skip if not installed, unless --force?)
         * Create service instances (BackupManager, FileOperations, NpmRegistry)
         * Determine package name:
           - If options.beta: '@rokicool/gsd-opencode'
           - Else: 'gsd-opencode'
         * Create UpdateService with packageName
         * Call updateService.checkForUpdate()
         * Handle results:
           - If error: display error, continue to next scope
           - If already up to date: show message, continue
           - If update available: displayUpdateInfo()
         * If update available and not options.force:
           - Prompt for confirmation with promptConfirmation
           - Handle null response (Ctrl+C) -> return INTERRUPTED
           - If not confirmed -> return SUCCESS (cancelled)
         * Perform update:
           - Create ora spinner
           - Call updateService.performUpdate(targetVersion, { onProgress })
           - Update spinner text with progress
           - Stop spinner with success/fail
         * Display results

       - Return appropriate exit code:
         * ERROR_CODES.SUCCESS if all good
         * ERROR_CODES.GENERAL_ERROR if any failures
         * ERROR_CODES.INTERRUPTED if user cancelled
         * ERROR_CODES.PERMISSION_ERROR for permission issues

    6. Error handling:
       - Handle AbortPromptError (Ctrl+C during prompt)
       - Handle EACCES (permission denied)
       - Handle network errors
       - Handle version not found
       - Log stack trace in verbose mode

    7. Export updateCommand as named export
    8. Add default export

    9. Command-line behavior:
       - `gsd-opencode update` - Update to latest stable
       - `gsd-opencode update --beta` - Update to latest beta from @rokicool/gsd-opencode
       - `gsd-opencode update 2.0.0` - Update to specific version
       - `gsd-opencode update --beta 2.0.0-beta.1` - Update to specific beta version
       - `gsd-opencode update --global` - Update global only
       - `gsd-opencode update --local` - Update local only
       - `gsd-opencode update --force` - Skip confirmation

    Follow the exact patterns from repair.js for:
    - Option handling
    - Scope iteration
    - Confirmation prompting
    - Progress indication with ora
    - Error handling
    - Exit codes
  </action>
  <verify>
    node -e "
      import { updateCommand } from './src/commands/update.js';
      console.log('updateCommand imported successfully');
    "
  </verify>
  <done>updateCommand function exists, handles all options, displays formatted output, uses confirmation prompts, shows progress, returns proper exit codes</done>
</task>

<task type="auto">
  <name>Register update command in CLI</name>
  <files>bin/gsd.js</files>
  <action>
    Modify bin/gsd.js to register the update command:

    1. Add import:
       - Add `import { updateCommand } from '../src/commands/update.js';` with other command imports

    2. Add command registration after repair command (line ~221):
       ```javascript
       // Update command
       program
         .command('update [version]')
         .description('Update GSD-OpenCode to latest or specified version')
         .option('-g, --global', 'Update global installation only')
         .option('-l, --local', 'Update local installation only')
         .option('--beta', 'Update to beta version from @rokicool/gsd-opencode')
         .option('-f, --force', 'Skip confirmation prompt')
         .action(async (version, options, command) => {
           const globalOptions = command.parent.opts();
           const fullOptions = {
             ...options,
             version,
             verbose: globalOptions.verbose || options.verbose
           };

           const exitCode = await updateCommand(fullOptions);
           process.exit(exitCode);
         });
       ```

    3. Ensure the command:
       - Takes optional version argument
       - Has --global and --local flags
       - Has --beta flag for private registry
       - Has --force flag to skip confirmation
       - Passes version to updateCommand in options
       - Handles verbose flag properly

    4. Update knownCommands array in isLegacyArgs() function to include 'update':
       - Add 'update' to the knownCommands array (line ~78)
  </action>
  <verify>
    node bin/gsd.js update --help
  </verify>
  <done>Update command registered in bin/gsd.js with all options, help text displays correctly</done>
</task>

</tasks>

<verification>
1. `node bin/gsd.js update --help` shows proper usage
2. Import test: `node -e "import('./src/commands/update.js').then(m => console.log('OK'))"`
3. Command is listed in gsd-opencode --help
4. Update command accepts --global, --local, --beta, --force flags
5. Update command accepts optional version argument
6. Integration test: `./bin/gsd.js update --global --force` (requires installed version)
7. Exit codes: 0=success, 1=error, 2=permission, 130=interrupted
</verification>

<success_criteria>
- src/commands/update.js exists with updateCommand function
- bin/gsd.js registers update command with proper options
- User can run `gsd-opencode update` to check and update
- User can run `gsd-opencode update --beta` for beta versions
- User can run `gsd-opencode update 2.0.0` for specific version
- Current vs target version displayed before update
- Confirmation prompt shown before making changes (unless --force)
- Progress shown during update with ora spinner
- Results displayed after update
- Proper exit codes returned (0, 1, 2, 130)
- Error handling for network, permission, and version issues
- Follows existing command patterns (repair.js style)
</success_criteria>

<output>
After completion, create `.planning/phases/05-lifecycle-management/05-03-SUMMARY.md`
</output>
