---
phase: 04-self-healing
plan: 03
type: execute
wave: 3
depends_on: [04-02]
files_modified: [src/commands/repair.js, bin/gsd.js]
autonomous: true
user_setup: []

must_haves:
  truths:
    - User can run `gsd-opencode repair` to fix broken installations
    - Repair shows summary of issues grouped by type before fixing
    - Repair requires interactive confirmation before making changes
    - Repair shows progress during operations
    - Repair displays post-repair report with success/failure status
    - Repair returns exit code 0 on success, non-zero on any failure
  artifacts:
    - path: src/commands/repair.js
      provides: "CLI repair command implementation"
      exports: ["repairCommand"]
    - path: bin/gsd.js
      provides: "CLI registration for repair command"
  key_links:
    - from: repair command
      to: RepairService.detectIssues
      via: "repairService.detectIssues() to find issues"
    - from: repair command
      to: promptConfirmation
      via: "promptConfirmation() for user confirmation"
    - from: repair command
      to: RepairService.repair
      via: "repairService.repair() with progress callbacks"
---

<objective>
Create repair command that provides the CLI interface for automatic installation repair.

Purpose: Allow users to detect and fix broken installations through a simple CLI command with confirmation and progress reporting.
Output: src/commands/repair.js implementing repairCommand, and CLI registration in bin/gsd.js.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-self-healing/04-02-SUMMARY.md

<!-- Existing commands for reference -->
@src/commands/check.js
@src/commands/uninstall.js
@src/utils/interactive.js
@src/utils/logger.js

<!-- Phase context -->
**Requirements:**
- CLI-04: User can run `gsd-opencode repair` to fix broken installations
- REPAIR-01: Repair detects and reinstalls missing files
- REPAIR-02: Repair detects and replaces corrupted files
- REPAIR-03: Repair fixes broken path references in .md files
- REPAIR-04: Repair shows summary of issues found before fixing
- REPAIR-05: Repair requires interactive confirmation before making changes

**Command patterns from existing code:**
- Commands export async function that returns exit code
- Use logger for output (success, error, info, dim, heading)
- Support --verbose flag via setVerbose
- Handle permission errors with helpful messages
- Handle Ctrl+C gracefully (AbortPromptError)
- Return ERROR_CODES constants for exit codes

**Interactive patterns from uninstall.js:**
- Use promptConfirmation() for yes/no prompts
- Show summary before confirmation
- Handle cancellation (return null from prompt)
- Support --force flag (but for repair, we don't allow --force per decisions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create repair command with detection and summary display</name>
  <files>src/commands/repair.js</files>
  <action>
Create src/commands/repair.js following command patterns from check.js and uninstall.js:

1. Imports:
   - ScopeManager from '../services/scope-manager.js'
   - BackupManager from '../services/backup-manager.js'
   - FileOperations from '../services/file-ops.js'
   - RepairService from '../services/repair-service.js'
   - { promptConfirmation } from '../utils/interactive.js'
   - { logger, setVerbose } from '../utils/logger.js'
   - { ERROR_CODES } from '../../lib/constants.js'
   - fs, path, fileURLToPath for getting package version

2. Helper: getPackageVersion()
   - Copy from check.js (reads package.json)
   - Returns version string or '1.0.0' on failure

3. Helper: displayIssuesSummary(issues, scopeLabel)
   - Takes issues object from detectIssues()
   - Displays formatted summary using logger.heading, logger.info, logger.dim
   - Group by category: Missing Files, Corrupted Files, Path Issues
   - Show count and list files for each category
   - Example output:
     ```
     Global Installation Repair
     ==========================
     
     Missing Files (3):
       ✗ agents directory
       ✗ command/gsd/help.md
       ✗ get-shit-done/templates/summary.md
     
     Corrupted Files (2):
       ✗ agents/ro-commit.md
       ✗ command/gsd/install.md
     
     Path Issues (1):
       ✗ get-shit-done/templates/summary.md
     
     Total issues: 6
     ```

4. Helper: checkScope(scope, options)
   - Similar to check.js pattern
   - Returns { installed, issues, scopeLabel }
   - Returns null issues if not installed

5. Main repairCommand(options) function:
   - Accepts options: { global, local, verbose }
   - Set verbose mode
   - Determine scopes to check (global, local, or both)
   - For each scope:
     - Create ScopeManager, BackupManager, FileOperations, RepairService
     - Call repairService.detectIssues()
     - If no issues, show "No issues found" and continue
     - If issues found, display summary
     - Prompt for confirmation
     - If confirmed, call repairService.repair() with progress callbacks
     - Display post-repair report
   - Return appropriate exit code

6. Export: repairCommand as named export and default

7. Avoid:
   - Do NOT skip confirmation (repair always requires confirmation per decisions)
   - Do NOT support --force flag
   - Do NOT implement dry-run (check command does that)
  </action>
  <verify>
echo "Checking repair command structure" && node -e "
import('./src/commands/repair.js').then(({ repairCommand }) => {
  console.log('repairCommand exists:', typeof repairCommand === 'function');
}).catch(e => console.error(e.message));
"
  </verify>
  <done>
repair.js created with command structure, detection logic, and summary display. Command follows existing patterns from check.js and uninstall.js.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement progress reporting and post-repair display</name>
  <files>src/commands/repair.js</files>
  <action>
Add progress reporting and post-repair result display to repair command:

1. Progress reporting during repair:
   - Use ora spinner for progress indication (import from 'ora')
   - Pass onProgress callback to repairService.repair():
     ```javascript
     onProgress: ({ current, total, operation, file }) => {
       const percent = Math.round((current / total) * 100);
       spinner.text = `Repairing ${current}/${total} files... (${percent}%)`;
     }
     ```
   - Start spinner before repair: ora({ text: 'Starting repairs...', spinner: 'dots', color: 'cyan' })
   - Stop spinner on completion: spinner.succeed('Repairs completed')
   - Stop spinner on failure: spinner.fail('Some repairs failed')

2. Helper: displayRepairResults(results, scopeLabel)
   - Takes results from repairService.repair()
   - Displays detailed post-repair report:
     ```
     Repair Results for Global Installation
     ======================================
     
     Missing Files: 3 fixed
       ✓ agents directory
       ✓ command/gsd/help.md
       ✓ get-shit-done/templates/summary.md
     
     Corrupted Files: 2 fixed, 1 failed
       ✓ agents/ro-commit.md
       ✓ command/gsd/install.md
       ✗ command/gsd/config.md (Permission denied)
     
     Path Issues: 1 fixed
       ✓ get-shit-done/templates/summary.md
     
     Summary: 5 succeeded, 1 failed
     ```
   - Show checkmark (✓) for success, X (✗) for failure
   - Include error message for failed repairs
   - Use logger.success, logger.error, logger.info for appropriate levels

3. Backup notification:
   - After repair completion, show backup location:
     ```
     Backups saved to: ~/.config/opencode/.backups/
     ```
   - Use logger.dim for this informational message

4. Overall status:
   - If all repairs succeeded: logger.success('All repairs completed successfully')
   - If some repairs failed: logger.error('Some repairs failed. Run gsd-opencode check for details.')

5. Handle edge cases:
   - If no installation found: logger.info('No installation found at {scope}')
   - If no issues detected: logger.success('No issues detected at {scope}')
   - If user cancels: logger.info('Repair cancelled')

6. Avoid:
   - Do NOT show per-file progress (only overall progress)
   - Do NOT update spinner text more than once per second (throttle if needed)
   - Do NOT clear console (preserve scrollback)
  </action>
  <verify>
npm run lint src/commands/repair.js 2>&1 | grep -E "(error|warning)" | head -10 || echo "Linting passed"
  </verify>
  <done>
Progress reporting with ora spinner and detailed post-repair results display implemented. Command provides clear visual feedback during and after repair operations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register repair command in CLI and handle errors</name>
  <files>bin/gsd.js</files>
  <action>
Register repair command in bin/gsd.js and add error handling:

1. Import repair command:
   - Add: import { repairCommand } from '../src/commands/repair.js';

2. Register command in Commander:
   - Add after check command registration:
     ```javascript
     // Repair command
     program
       .command('repair')
       .description('Repair broken GSD-OpenCode installation')
       .option('-g, --global', 'Repair global installation only')
       .option('-l, --local', 'Repair local installation only')
       .action(async (options, command) => {
         const globalOptions = command.parent.opts();
         const fullOptions = {
           ...options,
           verbose: globalOptions.verbose || options.verbose
         };

         const exitCode = await repairCommand(fullOptions);
         process.exit(exitCode);
       });
     ```

3. Add error handling in repair.js:
   - Wrap main logic in try-catch
   - Handle AbortPromptError (user cancelled):
     ```javascript
     if (error.name === 'AbortPromptError' || error.message?.includes('cancel')) {
       logger.info('Repair cancelled by user');
       return ERROR_CODES.INTERRUPTED;
     }
     ```
   - Handle permission errors (EACCES):
     ```javascript
     if (error.code === 'EACCES') {
       logger.error('Permission denied: Cannot access installation directory');
       logger.dim('Suggestion: Check directory permissions or run with appropriate privileges.');
       return ERROR_CODES.PERMISSION_ERROR;
     }
     ```
   - Handle other errors with helpful messages

4. Return appropriate exit codes:
   - ERROR_CODES.SUCCESS (0): All repairs succeeded
   - ERROR_CODES.GENERAL_ERROR (1): Some repairs failed
   - ERROR_CODES.PERMISSION_ERROR (2): Permission denied
   - ERROR_CODES.INTERRUPTED (130): User cancelled

5. Test command integration:
   - Verify command appears in --help output
   - Verify options are documented correctly

6. Avoid:
   - Do NOT add --force flag (per phase decisions)
   - Do NOT add --dry-run flag (per phase decisions)
   - Do NOT modify other command registrations
  </action>
  <verify>
echo "Testing CLI integration" && node bin/gsd.js --help | grep -A 2 "repair" || echo "Command not found in help"
  </verify>
  <done>
Repair command registered in CLI with proper error handling and exit codes. Command appears in help output with correct options.
  </done>
</task>

</tasks>

<verification>
1. Repair command registered in bin/gsd.js with --global and --local options
2. Command shows summary of issues before confirmation
3. Interactive confirmation prompt before making changes
4. Progress spinner during repair operations
5. Post-repair report shows success/failure for each file
6. Proper error handling for permission errors and interruptions
7. Exit codes: 0 for success, 1 for repair failures, 2 for permission, 130 for interrupt
8. Follows existing command patterns (check.js, uninstall.js)
9. No --force flag (per decisions)
</verification>

<success_criteria>
- User can run `gsd-opencode repair` and see issue summary
- Command prompts for confirmation before making changes
- Progress indicator shows during repairs
- Post-repair report lists all repaired files with status
- Returns exit code 0 on full success, non-zero on any failure
- Handles permission errors with helpful messages
- Handles Ctrl+C gracefully
- Command appears in `gsd-opencode --help`
- Works with both --global and --local flags
</success_criteria>

<output>
After completion, create `.planning/phases/04-self-healing/04-03-SUMMARY.md` documenting:
- Repair command workflow (detect -> summarize -> confirm -> repair -> report)
- Exit codes and error handling
- Progress reporting implementation
- Integration with RepairService
</output>
