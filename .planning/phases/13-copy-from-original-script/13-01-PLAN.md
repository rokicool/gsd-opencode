---
phase: 13-copy-from-original-script
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/copy-services/SubmoduleService.js
  - assets/copy-services/SyncManifest.js
  - assets/copy-services/__tests__/SubmoduleService.test.js
  - assets/copy-services/__tests__/SyncManifest.test.js
autonomous: true
requirements:
  - CFOS-01
  - CFOS-04
must_haves:
  truths:
    - SubmoduleService can detect changes between git submodule commits using git diff-tree
    - SubmoduleService verifies submodule is initialized before operations
    - SyncManifest persists sync state to JSON file and reloads on startup
    - SyncManifest tracks file-level metadata (hashes, sync timestamps)
  artifacts:
    - path: "assets/copy-services/SubmoduleService.js"
      provides: "Git submodule operations (detectChanges, getCommitInfo, verifySubmodule)"
      exports: ["SubmoduleService"]
      min_lines: 100
    - path: "assets/copy-services/SyncManifest.js"
      provides: "JSON manifest for sync state tracking"
      exports: ["SyncManifest"]
      min_lines: 80
    - path: "assets/copy-services/__tests__/SubmoduleService.test.js"
      provides: "Unit tests for SubmoduleService"
    - path: "assets/copy-services/__tests__/SyncManifest.test.js"
      provides: "Unit tests for SyncManifest"
  key_links:
    - from: "SubmoduleService.detectChanges()"
      to: "git diff-tree command"
      via: "child_process.exec"
      pattern: "git diff-tree --no-commit-id --name-only"
    - from: "SyncManifest"
      to: ".planning/sync-manifest.json"
      via: "fs.readFile/fs.writeFile"
      pattern: "JSON.parse/JSON.stringify"
---

<objective>
Create foundation services for git submodule operations and sync state tracking. SubmoduleService handles all git operations on the original/get-shit-done submodule. SyncManifest persists and retrieves synchronization state to a JSON file.

Purpose: These services form the foundation for the copy-from-original script, providing reliable git integration and state persistence that other services depend on.
Output: SubmoduleService.js, SyncManifest.js, and comprehensive unit tests for both.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-copy-from-original-script/13-RESEARCH.md

# Git submodule at original/get-shit-done/ tracking TÃ‚CHES v1.20.5
# Manifest pattern from Phase 7 conventions
# ES Modules with type: module
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SubmoduleService for git operations</name>
  <files>assets/copy-services/SubmoduleService.js</files>
  <action>
    Create SubmoduleService class with methods:
    - verifySubmodule(): Check if .git exists in submodule, throw descriptive error if not
    - getCommitInfo(): Get current commit hash and version tag from submodule HEAD
    - detectChanges(sinceCommit?): Compare commits using git diff-tree, return {hasChanges, files[], fromCommit, toCommit}
    - isInitialized(): Boolean check for submodule readiness
    
    Use child_process.promises.exec for async git commands.
    SUBMODULE_PATH = './original/get-shit-done'
    
    Error handling: Provide actionable error messages (e.g., "Run: git submodule update --init --recursive")
  </action>
  <verify>node -e "import('./assets/copy-services/SubmoduleService.js').then(m => console.log('Exports:', Object.keys(m)))"</verify>
  <done>SubmoduleService exports verifySubmodule, getCommitInfo, detectChanges, isInitialized functions</done>
</task>

<task type="auto">
  <name>Task 2: Create SyncManifest for state tracking</name>
  <files>assets/copy-services/SyncManifest.js</files>
  <action>
    Create SyncManifest class with methods:
    - constructor(manifestPath): Set path to .planning/sync-manifest.json
    - load(): Read and parse JSON manifest, return default structure if missing
    - save(manifest): Write atomically using temp-then-move pattern
    - updateFile(filePath, {sourceHash, destHash, transformed}): Update single file entry
    - getFileStatus(filePath): Return {syncedAt, sourceHash, destHash, exists} or null
    - getLastSync(): Return {commit, date, version} or null
    - setLastSync({commit, date, version}): Update last sync metadata
    
    Default manifest structure per research:
    {
      version: '1.0.0',
      lastSync: { commit, date, version },
      files: { 'relative/path': { syncedAt, sourceHash, destHash, transformed } }
    }
    
    Atomic write: Write to temp file, then fs.rename for atomicity
  </action>
  <verify>node -e "import('./assets/copy-services/SyncManifest.js').then(m => console.log('Exports:', Object.keys(m)))"</verify>
  <done>SyncManifest exports load, save, updateFile, getFileStatus, getLastSync, setLastSync methods</done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for both services</name>
  <files>
    assets/copy-services/__tests__/SubmoduleService.test.js
    assets/copy-services/__tests__/SyncManifest.test.js
  </files>
  <action>
    Create test files using Node.js built-in test runner (node:test, node:assert):
    
    SubmoduleService tests:
    - isInitialized returns true when .git exists
    - isInitialized returns false when submodule empty
    - getCommitInfo returns {hash, version} from git commands
    - detectChanges returns proper structure with hasChanges, files array
    - verifySubmodule throws with helpful message when not initialized
    
    SyncManifest tests:
    - load creates default structure when file missing
    - save writes valid JSON that can be reloaded
    - updateFile adds file entry with hashes and timestamp
    - getFileStatus returns null for unknown files
    - getFileStatus returns metadata for tracked files
    - setLastSync/getLastSync roundtrip correctly
    - Atomic writes don't corrupt on crash
    
    Mock git commands using child_process for unit isolation.
  </action>
  <verify>node --test assets/copy-services/__tests__/*.test.js</verify>
  <done>All tests pass, coverage includes success and error paths</done>
</task>

</tasks>

<verification>
- SubmoduleService can detect git changes using diff-tree
- SyncManifest persists to JSON and survives reloads
- Both services have unit tests with mocks
- Error messages are actionable for users
</verification>

<success_criteria>
SubmoduleService and SyncManifest are complete with:
- Full git integration for change detection (CFOS-01)
- JSON manifest persistence with atomic writes (CFOS-04)
- Unit tests covering all methods
- Proper error handling with helpful messages
</success_criteria>

<output>
After completion, create `.planning/phases/13-copy-from-original-script/13-01-SUMMARY.md`
</output>
