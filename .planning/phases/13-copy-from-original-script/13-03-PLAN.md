---
phase: 13-copy-from-original-script
plan: "03"
type: execute
wave: 3
depends_on:
  - "13-02"
files_modified:
  - assets/bin/copy-from-original.js
  - assets/bin/__tests__/copy-from-original.integration.test.js
autonomous: true
requirements:
  - CFOS-01
  - CFOS-02
  - CFOS-04
  - CFOS-05
  - CFOS-06
  - CFOS-07
  - CFOS-08
  - CFOS-09
  - CFOS-10
  - CFOS-11
  - CFOS-12
  # Note: CFOS-03 (transformations) is handled by Phase 10 translate.js
  # This script only copies files - transformations are applied separately
must_haves:
  truths:
    - CLI command copy-from-original exists and is executable
    - Command integrates all services (SubmoduleService, SyncManifest, SyncService)
    - --dry-run flag previews changes without modifying files
    - --force flag auto-overwrites diverged files
    - --show-diff flag displays file diffs before syncing
    - Integration tests verify end-to-end workflow
  artifacts:
    - path: "assets/bin/copy-from-original.js"
      provides: "CLI command for copy-from-original"
      exports: ["default"]
      executable: true
      min_lines: 150
    - path: "assets/bin/__tests__/copy-from-original.integration.test.js"
      provides: "Integration tests for CLI command"
  key_links:
    - from: "CLI command"
      to: "SyncService.sync()"
      via: "Commander action handler"
      pattern: "syncService.sync({dryRun, force, showDiff})"
    - from: "CLI command"
      to: "SubmoduleService"
      via: "Change detection"
      pattern: "submoduleService.detectChanges()"
---

<objective>
Create the CLI command entry point that integrates all services into a user-facing command. The script uses Commander.js for argument parsing, ora for progress indication, and chalk for colored output. Includes integration tests to verify the complete workflow.

Purpose: Provide a user-friendly CLI for synchronizing changes from the original TÂCHES repository.
Output: copy-from-original.js CLI command and integration tests.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-copy-from-original-script/13-RESEARCH.md
@.planning/phases/13-copy-from-original-script/13-01-SUMMARY.md
@.planning/phases/13-copy-from-original-script/13-02-SUMMARY.md

# IMPORTANT: This script does NOT apply CC→OC transformations
# Transformations are handled separately by translate.js (Phase 10)
# This script ONLY copies from original/get-shit-done/ to gsd-opencode/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI command with Commander.js</name>
  <files>assets/bin/copy-from-original.js</files>
  <action>
    Create CLI command using Commander.js (already in dependencies):
    
    Command: copy-from-original
    Description: "Sync files from original TÂCHES repository to gsd-opencode"
    
    Options:
    - --dry-run, -d: "Preview changes without copying files"
    - --force, -f: "Overwrite diverged files without warning"
    - --show-diff: "Show file diffs before syncing"
    - --verbose, -v: "Show detailed output"
    
    Flow:
    1. Initialize services (SubmoduleService, SyncManifest, SyncService)
    2. Check if submodule is initialized (SubmoduleService.verifySubmodule)
    3. Detect changes (SubmoduleService.detectChanges)
    4. If no changes: print "Already up to date" and exit 0
    5. If changes found: print summary of changed files
    6. Call SyncService.sync() with user options
    7. Report results: copied, skipped, warnings, orphans
    8. Exit with appropriate code (0 = success, 1 = errors)
    
    Progress indication:
    - Use ora spinners for long operations
    - Use chalk for colored output (green=success, yellow=warning, red=error)
    - Show progress for file copying operations
    
    Error handling:
    - Catch and display user-friendly error messages
    - Suggest fixes for common issues (submodule not initialized)
    - Exit with non-zero code on failure
    
    Shebang: #!/usr/bin/env node
    Make executable with proper permissions
  </action>
  <verify>chmod +x assets/bin/copy-from-original.js && head -1 assets/bin/copy-from-original.js</verify>
  <done>CLI file exists, is executable, has proper shebang</done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests</name>
  <files>assets/bin/__tests__/copy-from-original.integration.test.js</files>
  <action>
    Create integration tests using Node.js test runner:
    
    Setup:
    - Create temporary git repository structure
    - Initialize mock submodule with test files
    - Create gsd-opencode directory
    
    Test cases:
    - No changes: exit 0, "Already up to date" message
    - Changes detected: lists files to sync
    - Dry-run mode: no files modified, preview shown
    - Full sync: files copied to correct locations
    - Force mode: diverged files overwritten
    - Show-diff: displays unified diff
    - Submodule not initialized: helpful error message
    - Binary files skipped: no corruption
    - Backups created: files in .planning/backups/
    - Orphans reported: extra files in gsd-opencode
    
    Cleanup:
    - Remove temp directories
    - Clean up backups
    
    Assert on:
    - Exit codes
    - Console output (stdout/stderr)
    - File existence and content
    - Manifest updates
  </action>
  <verify>node --test assets/bin/__tests__/copy-from-original.integration.test.js</verify>
  <done>Integration tests pass covering main workflows and edge cases</done>
</task>

</tasks>

<verification>
- CLI command runs without errors: node assets/bin/copy-from-original.js --help
- --dry-run shows preview without modifying files
- --force bypasses divergence warnings
- --show-diff displays file diffs
- Integration tests verify complete workflow
- All CFOS requirements implemented and tested
</verification>

<success_criteria>
CLI command is complete with:
- Commander.js integration with --dry-run, --force, --show-diff flags
- Integration with SubmoduleService, SyncManifest, SyncService
- Progress indication with ora spinners
- Colored output with chalk
- Integration tests passing
- All 12 CFOS requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/13-copy-from-original-script/13-03-SUMMARY.md`
</output>
