---
phase: 13-copy-from-original-script
plan: "02"
type: execute
wave: 2
depends_on:
  - "13-01"
files_modified:
  - assets/copy-services/SyncService.js
  - assets/utils/file-diff.js
  - assets/utils/backup.js
  - assets/utils/binary-check.js
  - assets/copy-services/__tests__/SyncService.test.js
autonomous: true
requirements:
  - CFOS-02
  - CFOS-05
  - CFOS-06
  - CFOS-07
  - CFOS-08
  - CFOS-09
  - CFOS-10
  - CFOS-11
  - CFOS-12
must_haves:
  truths:
    - SyncService copies files from original/get-shit-done to gsd-opencode with directory mapping
    - Dry-run mode previews changes without modifying files
    - Force mode bypasses divergence warnings
    - File diffs are shown before syncing
    - Diverged files are detected and reported
    - Binary files are skipped automatically
    - Backups are created before overwriting files
    - Operations use atomic temp-then-move pattern
    - Orphaned files in gsd-opencode are reported
  artifacts:
    - path: "assets/copy-services/SyncService.js"
      provides: "Orchestrates copy operations with atomic batch pattern"
      exports: ["SyncService"]
      min_lines: 200
    - path: "assets/utils/file-diff.js"
      provides: "File content comparison utilities"
      exports: ["computeHash", "getFileDiff", "filesAreEqual"]
    - path: "assets/utils/backup.js"
      provides: "Backup creation before file modifications"
      exports: ["createBackup", "restoreBackup", "cleanupBackup"]
    - path: "assets/utils/binary-check.js"
      provides: "Binary file detection"
      exports: ["isBinaryFile"]
    - path: "assets/copy-services/__tests__/SyncService.test.js"
      provides: "Unit tests for SyncService"
  key_links:
    - from: "SyncService"
      to: "SubmoduleService"
      via: "Constructor injection"
      pattern: "new SyncService(submoduleService, syncManifest)"
    - from: "SyncService"
      to: "SyncManifest"
      via: "State tracking"
      pattern: "manifest.updateFile()"
    - from: "SyncService.sync()"
      to: "Atomic temp directory"
      via: "Stage-then-move pattern"
      pattern: "fs.mkdtemp + fs.rename"
---

<objective>
Create SyncService and supporting utilities for orchestrating file copy operations. SyncService handles directory mapping, divergence detection, binary skipping, backup creation, atomic operations, and orphan reporting. Supporting utilities provide file diffing, backup management, and binary detection.

Purpose: Core service that implements the actual sync logic with all safety features required.
Output: SyncService.js, file-diff.js, backup.js, binary-check.js, and comprehensive tests.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-copy-from-original-script/13-RESEARCH.md
@.planning/phases/13-copy-from-original-script/13-01-SUMMARY.md

# CRITICAL: This script does NOT perform transformations - only copies files
# Directory mapping: commands/ (original) → command/ (gsd-opencode) - singular
# Target: gsd-opencode/ folder (to be processed by translate.js later)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create utility modules (file-diff, backup, binary-check)</name>
  <files>
    assets/utils/file-diff.js
    assets/utils/backup.js
    assets/utils/binary-check.js
  </files>
  <action>
    Create three utility modules:
    
    file-diff.js:
    - computeHash(filePath): Return SHA256 hash of file content
    - filesAreEqual(file1, file2): Compare hashes efficiently
    - getFileDiff(original, modified): Use 'diff' library for unified diff output
    
    backup.js:
    - createBackup(filePath): Copy to .planning/backups/{timestamp}/{relativePath}
    - restoreBackup(backupPath, originalPath): Restore from backup
    - cleanupBackup(backupPath): Remove backup after successful sync
    - Backup directory: .planning/backups/{ISO-date}/{file-path}
    
    binary-check.js:
    - isBinaryFile(filePath): Check first 512 bytes for null bytes
    - Return true if any null byte found, false otherwise
    
    All utilities use fs/promises and return Promises.
  </action>
  <verify>node -e "import('./assets/utils/file-diff.js').then(m => console.log('file-diff:', Object.keys(m))); import('./assets/utils/backup.js').then(m => console.log('backup:', Object.keys(m))); import('./assets/utils/binary-check.js').then(m => console.log('binary-check:', Object.keys(m)))"</verify>
  <done>Three utility modules export expected functions</done>
</task>

<task type="auto">
  <name>Task 2: Create SyncService with full sync logic</name>
  <files>assets/copy-services/SyncService.js</files>
  <action>
    Create SyncService class accepting (submoduleService, syncManifest) in constructor.
    
    Key features:
    
    DIRECTORY_MAPPING constant:
    {
      'agents/': 'gsd-opencode/agents/',
      'commands/gsd/': 'gsd-opencode/command/gsd/',  // Note: singular 'command'
      'get-shit-done/references/': 'gsd-opencode/get-shit-done/references/',
      'get-shit-done/templates/': 'gsd-opencode/get-shit-done/templates/',
      'get-shit-done/workflows/': 'gsd-opencode/get-shit-done/workflows/'
    }
    
    Methods:
    - getTargetPath(sourcePath): Map using DIRECTORY_MAPPING, return null if no match
    - findOrphanedFiles(): List files in gsd-opencode not present in original
    - detectDivergence(sourcePath, destPath): Compare hashes, warn if dest modified
    - sync(options): Main sync method with {dryRun, force, showDiff}
    
    Atomic batch pattern in sync():
    1. Stage all changes to temp directory using fs.mkdtemp
    2. Create backups before overwriting
    3. Skip binary files (check with binary-check.js)
    4. Show diffs if showDiff option set
    5. If dryRun: report what would happen, return
    6. Detect divergences, warn unless force mode
    7. Apply atomically with fs.rename
    8. Update manifest after success
    9. Cleanup temp directory
    
    Return result object: {copied, skipped, warnings, orphans}
  </action>
  <verify>node -e "import('./assets/copy-services/SyncService.js').then(m => console.log('Exports:', Object.keys(m)))"</verify>
  <done>SyncService exports with getTargetPath, findOrphanedFiles, detectDivergence, sync methods</done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive SyncService tests</name>
  <files>assets/copy-services/__tests__/SyncService.test.js</files>
  <action>
    Create tests using Node.js test runner:
    
    Setup:
    - Create temp directories for original and destination
    - Mock SubmoduleService and SyncManifest
    
    Tests:
    - getTargetPath maps directories correctly (including singular/plural)
    - getTargetPath returns null for unmapped paths
    - sync copies files with dryRun=true (no actual changes)
    - sync copies files with dryRun=false
    - Binary files are skipped automatically
    - Divergence detection warns without force flag
    - Force flag bypasses divergence warnings
    - Backups created before overwriting
    - Atomic operations (all succeed or none)
    - Orphaned files are reported
    - showDiff generates diff output
    
    Cleanup:
    - Remove temp directories after each test
  </action>
  <verify>node --test assets/copy-services/__tests__/SyncService.test.js</verify>
  <done>All tests pass, covering all CFOS requirements implemented</done>
</task>

</tasks>

<verification>
- Directory mapping handles singular vs plural (commands/ → command/)
- Dry-run mode previews without modifying files (CFOS-05)
- Force flag bypasses divergence warnings (CFOS-06)
- Diffs shown before syncing (CFOS-07)
- Diverged files detected and warned (CFOS-08)
- Binary files skipped (CFOS-09)
- Backups created before overwriting (CFOS-10)
- Atomic operations use temp-then-move (CFOS-11)
- Orphans reported (CFOS-12)
</verification>

<success_criteria>
SyncService is complete with:
- File copying with directory mapping (CFOS-02)
- Dry-run, force, showDiff modes (CFOS-05, CFOS-06, CFOS-07)
- Divergence detection (CFOS-08)
- Binary skipping (CFOS-09)
- Backup creation (CFOS-10)
- Atomic operations (CFOS-11)
- Orphan reporting (CFOS-12)
- Unit tests covering all features
</success_criteria>

<output>
After completion, create `.planning/phases/13-copy-from-original-script/13-02-SUMMARY.md`
</output>
