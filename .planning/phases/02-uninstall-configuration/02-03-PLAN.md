---
phase: 02-uninstall-configuration
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified: [src/commands/config.js, bin/gsd.js]
autonomous: true

must_haves:
  truths:
    - "User can run `gsd-opencode config get <key>` to read a setting"
    - "User can run `gsd-opencode config set <key> <value>` to change a setting"
    - "User can run `gsd-opencode config reset [key]` to restore defaults"
    - "User can run `gsd-opencode config list` to see all settings"
    - "Config values auto-parse (boolean, number, JSON string)"
    - "Settings persist across command invocations"
  artifacts:
    - path: "src/commands/config.js"
      provides: "Config command with get/set/reset/list subcommands"
      min_lines: 180
    - path: "bin/gsd.js"
      provides: "CLI registration for config and uninstall commands"
      modified: true
  key_links:
    - from: "config command"
      to: "SettingsManager"
      via: "new SettingsManager()"
      pattern: "settings.get/set/reset/list calls"
    - from: "bin/gsd.js"
      to: "config subcommands"
      via: "program.command('config').addCommand(...)"
      pattern: "Commander.js subcommand registration"
---

<objective>
Create config command with subcommands (get, set, reset, list) and register both config and uninstall commands in CLI entry point.

Purpose: Provide users with full configuration management and complete the CLI command set for Phase 2.
Output: `src/commands/config.js` with four subcommand functions, and updated `bin/gsd.js` with command registrations
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-uninstall-configuration/02-RESEARCH.md

# Dependencies from Phase 1 and 02-01
@src/services/settings.js
@src/utils/logger.js
@src/utils/interactive.js
@lib/constants.js
@bin/gsd.js

# Patterns to follow
@src/commands/install.js
@src/commands/list.js
</context>

<tasks>

<task type="auto">
  <name>Create config command with four subcommands</name>
  <files>src/commands/config.js</files>
  <action>
Create `src/commands/config.js` with full subcommand implementation:

1. **Imports**:
   - `SettingsManager` from '../services/settings.js'
   - `logger, setVerbose` from '../utils/logger.js'
   - `ERROR_CODES` from '../../lib/constants.js'

2. **configGetCommand(key, options)**:
   - Validate key is provided (error if missing)
   - Create SettingsManager instance
   - Get value: `await settings.get(key)`
   - If undefined: log error "key not found", return GENERAL_ERROR
   - Output raw value to stdout (use `console.log`, not logger):
     - Objects: JSON.stringify
     - Others: String(value)
   - Return SUCCESS
   - Handle errors: log and return GENERAL_ERROR

3. **configSetCommand(key, value, options)**:
   - Validate key and value provided
   - Parse value intelligently:
     - `'true'` → `true`
     - `'false'` → `false`
     - Numbers: parse if !isNaN and not empty string
     - JSON: try JSON.parse if starts with `{` or `[`
     - Otherwise: keep as string
   - Create SettingsManager
   - `await settings.set(key, parsedValue)`
   - Log success: `Set ${key} = ${JSON.stringify(parsedValue)}`
   - Return SUCCESS
   - Handle errors appropriately

4. **configResetCommand(key, options)**:
   - If `options.all` is true:
     - `await settings.reset()` (no key = reset all)
     - Log: 'All configuration reset to defaults'
   - Else if key provided:
     - `await settings.reset(key)`
     - Log: `Reset ${key} to default`
   - Else:
     - Log error: 'Specify a key or use --all'
     - Return GENERAL_ERROR
   - Return SUCCESS
   - Handle errors

5. **configListCommand(options)**:
   - Create SettingsManager
   - `const config = await settings.list()`
   - If `options.json`:
     - Output: `console.log(JSON.stringify(config, null, 2))`
   - Else (human-readable):
     - `logger.heading('Configuration')`
     - Show source path: `logger.dim('Source: ' + settings.getConfigPath())`
     - Flatten object with helper function
     - Find max key length for alignment
     - Print each key-value pair with aligned columns
     - Format values (boolean: true/false, strings as-is, others JSON)
   - Return SUCCESS
   - Handle errors

6. **Helper functions**:
   - `flattenObject(obj, prefix='', result={})` - Recursively flatten nested objects
   - `formatValue(value)` - Format for display (booleans as 'true'/'false', etc.)

7. **Error handling**:
   - Wrap each command in try/catch
   - Log errors with `logger.error`
   - Return appropriate ERROR_CODES
   - Handle SettingsManager errors (invalid JSON, permissions)

8. **Exports**:
   - `export { configGetCommand, configSetCommand, configResetCommand, configListCommand }`

Follow patterns from list.js: use logger for user-facing output, console.log for scriptable output (get, list --json).
  </action>
  <verify>
    - Test each subcommand:
      ```bash
      # Test set
      node bin/gsd.js config set ui.colors false
      
      # Test get
      node bin/gsd.js config get ui.colors | grep "false"
      
      # Test list
      node bin/gsd.js config list | grep "ui.colors"
      
      # Test reset
      node bin/gsd.js config reset ui.colors
      node bin/gsd.js config get ui.colors | grep "true"
      
      # Test JSON output
      node bin/gsd.js config list --json | python3 -m json.tool > /dev/null && echo "Valid JSON"
      ```
    
    - Test value parsing:
      ```bash
      node bin/gsd.js config set test.bool true
      node bin/gsd.js config set test.num 42
      node bin/gsd.js config set test.str hello
      node bin/gsd.js config list | grep -E "test\.(bool|num|str)"
      ```
    
    - Test error cases:
      ```bash
      # Missing key
      node bin/gsd.js config get; echo "Exit: $?"
      
      # Invalid key
      node bin/gsd.js config get nonexistent.key; echo "Exit: $?"
      ```
  </verify>
  <done>All four subcommands implemented, value parsing works, error handling in place</done>
</task>

<task type="auto">
  <name>Register config and uninstall commands in bin/gsd.js</name>
  <files>bin/gsd.js</files>
  <action>
Update `bin/gsd.js` to register both new commands:

1. **Add imports** at top of file (after existing imports):
   ```javascript
   import { uninstallCommand } from '../src/commands/uninstall.js';
   import { 
     configGetCommand, 
     configSetCommand, 
     configResetCommand, 
     configListCommand 
   } from '../src/commands/config.js';
   ```

2. **Register uninstall command** (after list command):
   ```javascript
   program
     .command('uninstall')
     .alias('rm')
     .description('Remove GSD-OpenCode installation')
     .option('-g, --global', 'Remove global installation')
     .option('-l, --local', 'Remove local installation')
     .option('-f, --force', 'Skip confirmation prompt')
     .action(async (options, command) => {
       const globalOptions = command.parent.opts();
       const exitCode = await uninstallCommand({ ...options, verbose: globalOptions.verbose });
       process.exit(exitCode);
     });
   ```

3. **Register config command with subcommands**:
   ```javascript
   const configCmd = program
     .command('config')
     .description('Manage GSD-OpenCode configuration');

   configCmd
     .command('get <key>')
     .description('Get a configuration value')
     .action(async (key, options, command) => {
       const globalOptions = command.parent.parent.opts();
       const exitCode = await configGetCommand(key, { verbose: globalOptions.verbose });
       process.exit(exitCode);
     });

   configCmd
     .command('set <key> <value>')
     .description('Set a configuration value')
     .action(async (key, value, options, command) => {
       const globalOptions = command.parent.parent.opts();
       const exitCode = await configSetCommand(key, value, { verbose: globalOptions.verbose });
       process.exit(exitCode);
     });

   configCmd
     .command('reset [key]')
     .description('Reset configuration to defaults')
     .option('--all', 'Reset all settings')
     .action(async (key, options, command) => {
       const globalOptions = command.parent.parent.opts();
       const exitCode = await configResetCommand(key, { ...options, verbose: globalOptions.verbose });
       process.exit(exitCode);
     });

   configCmd
     .command('list')
     .alias('ls')
     .description('List all configuration settings')
     .option('--json', 'Output as JSON')
     .action(async (options, command) => {
       const globalOptions = command.parent.parent.opts();
       const exitCode = await configListCommand({ ...options, verbose: globalOptions.verbose });
       process.exit(exitCode);
     });
   ```

4. **Verify structure**:
   - Ensure imports are at top
   - Commands are registered before `program.parse()`
   - Each action properly extracts globalOptions from parent
   - All use process.exit(exitCode) pattern

5. **Test CLI integration**:
   - Run `node bin/gsd.js --help` - should show uninstall and config
   - Run `node bin/gsd.js config --help` - should show subcommands
   - Run `node bin/gsd.js uninstall --help` - should show options
  </action>
  <verify>
    - Check help output shows new commands:
      ```bash
      node bin/gsd.js --help | grep -E "(uninstall|config)"
      ```
    
    - Check config subcommands:
      ```bash
      node bin/gsd.js config --help | grep -E "(get|set|reset|list)"
      ```
    
    - Test full command flow:
      ```bash
      # Set a value
      node bin/gsd.js config set test.phase2 "works"
      
      # Get the value
      node bin/gsd.js config get test.phase2
      
      # Clean up
      node bin/gsd.js config reset test.phase2
      ```
    
    - Verify exit codes:
      ```bash
      node bin/gsd.js config get nonexistent 2>/dev/null; echo "Exit: $?"
      # Should be 1 (GENERAL_ERROR)
      ```
  </verify>
  <done>Both commands registered in CLI, help works, full command flow tested</done>
</task>

</tasks>

<verification>
**Goal-Backward Checks:**
- [ ] `src/commands/config.js` exists with ~180+ lines
- [ ] `bin/gsd.js` imports and registers both uninstall and config commands
- [ ] `gsd-opencode config get <key>` returns value (or error if not set)
- [ ] `gsd-opencode config set <key> <value>` parses booleans, numbers, JSON
- [ ] `gsd-opencode config reset <key>` restores default
- [ ] `gsd-opencode config reset --all` removes entire config
- [ ] `gsd-opencode config list` shows human-readable table
- [ ] `gsd-opencode config list --json` outputs valid JSON
- [ ] `gsd-opencode uninstall` shows summary and confirms
- [ ] `gsd-opencode uninstall --force` skips confirmation
- [ ] All commands respect --verbose global flag
- [ ] Exit codes are correct (0 success, 1 error, 130 interrupted)

**Integration:**
- [ ] Help shows all commands: `gsd-opencode --help`
- [ ] Config subcommands have their own help
- [ ] Settings persist across invocations (test: set, exit, get)
- [ ] No import errors or runtime exceptions
</verification>

<success_criteria>
Config command and CLI registration complete:
- ✅ Config command with get/set/reset/list subcommands
- ✅ Value auto-parsing (boolean, number, JSON, string)
- ✅ Settings persist across invocations
- ✅ Human-readable and JSON output modes
- ✅ Uninstall command registered and functional
- ✅ All commands appear in --help
- ✅ Verbose flag passed through correctly
- ✅ Proper exit codes throughout
- ✅ Follows Phase 1 patterns (logger, error handling)

Phase 2 Requirements Met:
- ✅ CLI-02: `gsd-opencode uninstall` command
- ✅ CLI-07: `gsd-opencode config` command
- ✅ UNIN-01 through UNIN-05: All uninstall requirements
- ✅ CONFIG-01 through CONFIG-04: All config requirements
</success_criteria>

<output>
After completion, create `.planning/phases/02-uninstall-configuration/02-03-SUMMARY.md`
</output>
