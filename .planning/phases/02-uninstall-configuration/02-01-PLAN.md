---
phase: 02-uninstall-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/services/settings.js]
autonomous: true

must_haves:
  truths:
    - "Settings can be persisted to disk using XDG Base Directory spec"
    - "Dot-notation keys work for nested config access"
    - "Atomic writes prevent corruption on crash"
    - "Default values apply when user config is missing"
    - "In-memory caching improves read performance"
  artifacts:
    - path: "src/services/settings.js"
      provides: "SettingsManager class with get/set/reset/list methods"
      min_lines: 200
  key_links:
    - from: "SettingsManager"
      to: "~/.config/gsd-opencode/settings.json"
      via: "fs.writeFile temp-then-rename"
      pattern: "_save\\(\\) with atomic writes"
    - from: "dot-notation key"
      to: "nested object property"
      via: "_getNested/_setNested methods"
      pattern: "key\\.split\\('\\.'\\)"
---

<objective>
Create SettingsManager service for persistent user configuration with XDG-compliant storage, atomic writes, dot-notation key access, and default value support.

Purpose: Enable reliable configuration persistence for CLI settings like install.defaultScope, ui.colors, and user preferences.
Output: `src/services/settings.js` with SettingsManager class exposing get, set, reset, list methods
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-uninstall-configuration/02-RESEARCH.md

@src/services/scope-manager.js
@src/services/config.js
</context>

<tasks>

<task type="auto">
  <name>Create SettingsManager class with XDG config location</name>
  <files>src/services/settings.js</files>
  <action>
Create SettingsManager class in `src/services/settings.js`:

1. **Constructor**:
   - Follow XDG Base Directory spec: use `XDG_CONFIG_HOME` env var, fallback to `~/.config`
   - Set config path: `~/.config/gsd-opencode/settings.json`
   - Define default values object with sensible defaults:
     - `'install.defaultScope': 'global'`
     - `'ui.colors': true`
     - `'ui.progressBars': true`
     - `'behavior.confirmDestructive': true`
     - `'logging.verbose': false`
   - Initialize in-memory cache (`_cache`, `_cacheValid`)

2. **Public methods** (async):
   - `get(key)` - Get value by dot-notation key, return default if not set
   - `set(key, value)` - Set value by dot-notation key
   - `reset(key?)` - Reset specific key to default, or reset all if key omitted
   - `list()` - Return all config values merged with defaults
   - `getConfigPath()` - Return absolute path to config file
   - `getRaw()` - Return user config without defaults

3. **Private helpers**:
   - `_load()` - Read and parse JSON from disk, return `{}` if file doesn't exist
   - `_save(config)` - Atomic write using temp file + rename pattern
   - `_getNested(obj, key)` - Dot-notation getter using `key.split('.')`
   - `_setNested(obj, key, value)` - Dot-notation setter with auto-creation of intermediate objects
   - `_deleteNested(obj, key)` - Dot-notation deleter for reset
   - `_deepMerge(target, ...sources)` - Merge objects recursively

4. **Error handling**:
   - Handle ENOENT gracefully (return empty config)
   - Handle invalid JSON with descriptive error
   - Clean up temp files on write errors
   - Re-throw unexpected errors

Follow Phase 1 patterns: use `fs/promises`, async methods, clear JSDoc comments.
  </action>
  <verify>
    - Create test script that exercises all methods:
      ```bash
      node -e "
      import { SettingsManager } from './src/services/settings.js';
      const s = new SettingsManager();
      
      // Test get with defaults
      const scope = await s.get('install.defaultScope');
      console.log('Default scope:', scope);
      
      // Test set
      await s.set('test.key', 'value');
      const val = await s.get('test.key');
      console.log('Set/get works:', val === 'value');
      
      // Test list
      const all = await s.list();
      console.log('Has test.key:', 'test' in all);
      
      // Test reset
      await s.reset('test.key');
      const after = await s.get('test.key');
      console.log('Reset works:', after === undefined);
      
      console.log('Config path:', s.getConfigPath());
      console.log('ALL TESTS PASSED');
      "
      ```
    - Verify file exists at ~/.config/gsd-opencode/settings.json
    - Verify atomic writes work (check temp file cleanup)
  </verify>
  <done>SettingsManager class implements all required methods, uses XDG-compliant path, supports dot-notation, atomic writes verified</done>
</task>

<task type="auto">
  <name>Add TypeScript JSDoc types and export</name>
  <files>src/services/settings.js</files>
  <action>
Add comprehensive JSDoc to SettingsManager class:

1. **Class documentation**:
   - @class SettingsManager
   - @description Manages user configuration with XDG-compliant storage and atomic writes
   - @example usage code

2. **Method documentation** for each public method:
   - @param types and descriptions
   - @returns type and description
   - @throws documentation if applicable
   - @async where applicable

3. **Type definitions**:
   - Define @typedef for ConfigValue (string | number | boolean | object)
   - Document dot-notation key format

4. **Add module export**:
   - `export { SettingsManager }` at end of file
   - Use ES module syntax (type: module project)

5. **Inline comments** for complex logic:
   - Explain atomic write pattern
   - Explain cache invalidation strategy
   - Document why XDG spec is used
  </action>
  <verify>
    - Run `node --check src/services/settings.js` to verify syntax
    - Review JSDoc completeness with: `grep -c "@param\|@returns\|@throws" src/services/settings.js`
    - Verify export is at end of file
  </verify>
  <done>All public methods have JSDoc, types documented, ES module export in place</done>
</task>

</tasks>

<verification>
**Goal-Backward Checks:**
- [ ] SettingsManager file exists at `src/services/settings.js` (~200+ lines)
- [ ] `get()` returns defaults when key not in user config
- [ ] `set()` uses atomic write (temp file + rename)
- [ ] `reset()` removes specific key or entire config file
- [ ] `list()` merges user config with defaults
- [ ] Dot-notation works: `await settings.set('a.b.c', 'value')` stores nested object
- [ ] Config file location follows XDG spec (`~/.config/gsd-opencode/settings.json`)
- [ ] Cache improves performance (check that _load is called only once for multiple gets)

**Integration:**
- [ ] Import works: `import { SettingsManager } from './src/services/settings.js'`
- [ ] No runtime errors in test script
- [ ] Config persists across process restarts
</verification>

<success_criteria>
SettingsManager service is complete and tested:
- ✅ XDG-compliant config location (respects XDG_CONFIG_HOME)
- ✅ Atomic file writes prevent corruption
- ✅ Dot-notation key access (a.b.c creates nested objects)
- ✅ Default values apply automatically
- ✅ All CRUD operations: get, set, reset, list
- ✅ In-memory caching for performance
- ✅ Proper error handling (ENOENT, invalid JSON)
- ✅ ES module with proper exports

Ready for Plan 02-02 (Uninstall) and Plan 02-03 (Config) integration.
</success_criteria>

<output>
After completion, create `.planning/phases/02-uninstall-configuration/02-01-SUMMARY.md`
</output>
