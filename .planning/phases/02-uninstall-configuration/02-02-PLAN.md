---
phase: 02-uninstall-configuration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/commands/uninstall.js]
autonomous: true

must_haves:
  truths:
    - "User can run `gsd-opencode uninstall` to remove installation"
    - "Uninstall detects scope automatically if only one installation exists"
    - "Summary shows what will be removed before confirmation"
    - "Interactive confirmation required by default (default: false for safety)"
    - "--force flag skips confirmation for scripting"
    - "Handles permission errors with helpful message and exit code 2"
    - "Handles SIGINT (Ctrl+C) gracefully with exit code 130"
  artifacts:
    - path: "src/commands/uninstall.js"
      provides: "Uninstall command with detection, summary, confirmation, removal"
      min_lines: 150
  key_links:
    - from: "uninstall command"
      to: "ScopeManager"
      via: "new ScopeManager({ scope })"
      pattern: "scope detection and validation"
    - from: "uninstall command"
      to: "@inquirer/prompts"
      via: "promptConfirmation"
      pattern: "interactive confirmation"
---

<objective>
Create uninstall command that safely removes GSD-OpenCode installation with automatic scope detection, pre-deletion summary, interactive confirmation, and --force flag.

Purpose: Allow users to cleanly remove GSD-OpenCode while protecting against accidental deletion through confirmation and clear communication.
Output: `src/commands/uninstall.js` with `uninstallCommand(options)` function
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-uninstall-configuration/02-RESEARCH.md

# Phase 1 patterns to follow
@src/commands/install.js
@src/services/scope-manager.js
@src/utils/logger.js
@src/utils/interactive.js
@lib/constants.js
</context>

<tasks>

<task type="auto">
  <name>Create uninstall command with scope detection</name>
  <files>src/commands/uninstall.js</files>
  <action>
Create `src/commands/uninstall.js` with full implementation:

1. **Imports** (follow install.js pattern):
   - `ScopeManager` from '../services/scope-manager.js'
   - `logger, setVerbose` from '../utils/logger.js'
   - `promptConfirmation` from '../utils/interactive.js'
   - `ERROR_CODES, DIRECTORIES_TO_COPY` from '../../lib/constants.js'
   - `fs/promises`, `path` from Node.js

2. **Main function** `uninstallCommand(options = {})`:
   - Call `setVerbose(options.verbose)` at start
   - Wrap in try/catch for error handling

3. **Scope detection logic**:
   - If `options.global` or `options.local` provided, use that
   - Otherwise, auto-detect:
     - Create both global and local ScopeManagers
     - Check `isInstalled()` on both
     - If both installed: log warning, tell user to use --global or --local, return GENERAL_ERROR
     - If neither installed: log warning, return GENERAL_ERROR
     - If only one: use that scope

4. **Identify items to remove**:
   - Initialize `itemsToRemove = []`
   - Check for VERSION file using `fs.access`
   - Check for each directory in `DIRECTORIES_TO_COPY` using `fs.stat`
   - Build array with `{ type: 'file'|'directory', path, name }` objects
   - If no items found: log warning, return GENERAL_ERROR

5. **Display summary**:
   - `logger.heading('Uninstall GSD-OpenCode')`
   - Show scope and location (use `scopeManager.getPathPrefix()`)
   - List items to remove with icons (üìÅ directory, üìÑ file)
   - Use `logger.dim` for decorative spacing

6. **Interactive confirmation**:
   - If `!options.force`:
     - Call `promptConfirmation('Are you sure you want to proceed?', false)`
     - Handle `null` return (SIGINT): log 'cancelled', return INTERRUPTED
     - Handle `false` return: log 'cancelled', return SUCCESS
   - If `options.force`: skip confirmation

7. **Perform removal**:
   - Log 'Removing files...'
   - Loop through `itemsToRemove`:
     - Use `fs.rm(item.path, { recursive: true, force: true })`
     - Log debug message for each removal
   - Try to remove parent directory with `fs.rmdir(targetDir)` (ignore error if not empty)

8. **Success message**:
   - `logger.success('GSD-OpenCode has been successfully uninstalled')`
   - Show count of removed items and location
   - Return SUCCESS

9. **Error handling**:
   - `AbortPromptError` (Ctrl+C): log 'cancelled', return INTERRUPTED
   - `EACCES`: log permission error with suggestion, return PERMISSION_ERROR
   - Other errors: log error message, return GENERAL_ERROR

Follow Phase 1 patterns from install.js: verbose logging, clear error messages, proper exit codes.
  </action>
  <verify>
    - Test scope detection:
      ```bash
      # Without installation - should warn
      node bin/gsd.js uninstall 2>&1 | grep -i "no.*installation"
      
      # With --force - should attempt removal (will warn if not installed)
      node bin/gsd.js uninstall --force 2>&1
      ```
    
    - Test with mock installation:
      ```bash
      # Create mock global installation
      mkdir -p ~/.config/opencode/agents
      echo '{"version":"1.0.0"}' > ~/.config/opencode/VERSION
      
      # Test uninstall shows summary
      node bin/gsd.js uninstall --global 2>&1 | grep -i "will be removed"
      
      # Cleanup mock
      rm -rf ~/.config/opencode
      ```
    
    - Verify error codes:
      ```bash
      node -e "process.exit((await import('./src/commands/uninstall.js')).uninstallCommand({global:true}))" 2>/dev/null
echo "Exit code: $?"
      ```
  </verify>
  <done>Uninstall command detects scope, shows summary, handles confirmation, removes files, proper exit codes</done>
</task>

<task type="auto">
  <name>Add JSDoc and export</name>
  <files>src/commands/uninstall.js</files>
  <action>
Add comprehensive documentation to uninstall.js:

1. **Module documentation** at top:
   - @module commands/uninstall
   - @description Uninstall command for removing GSD-OpenCode installations
   - @example Usage examples with different flags

2. **Function documentation** for `uninstallCommand`:
   - @param {Object} options - Command options
   - @param {boolean} [options.global] - Remove global installation
   - @param {boolean} [options.local] - Remove local installation  
   - @param {boolean} [options.force] - Skip confirmation
   - @param {boolean} [options.verbose] - Enable verbose logging
   - @returns {Promise<number>} Exit code (0=success, 1=error, 2=permission, 130=interrupted)
   - @async

3. **Inline comments** for complex sections:
   - Explain auto-detection logic
   - Document why items are checked before removal
   - Explain atomic removal approach

4. **Add export**:
   - `export { uninstallCommand }` at end
   - Ensure named export (not default)

5. **Code style**:
   - Use same style as install.js
   - Consistent spacing and formatting
   - Clear variable names
  </action>
  <verify>
    - Run `node --check src/commands/uninstall.js` for syntax
    - Compare structure with install.js to ensure consistency
    - Verify export exists: `grep "export { uninstallCommand }" src/commands/uninstall.js`
  </verify>
  <done>Full JSDoc, inline comments, named export, consistent with install.js style</done>
</task>

</tasks>

<verification>
**Goal-Backward Checks:**
- [ ] File exists at `src/commands/uninstall.js` (~150+ lines)
- [ ] `uninstallCommand` exported and importable
- [ ] Auto-detects scope when only one installation exists
- [ ] Errors when both global+local exist without flags
- [ ] Shows summary of items to remove before confirmation
- [ ] Confirmation defaults to false (safety first)
- [ ] `--force` flag skips confirmation
- [ ] Removes VERSION file and all directories from DIRECTORIES_TO_COPY
- [ ] Handles EACCES with exit code 2
- [ ] Handles SIGINT with exit code 130
- [ ] Verbose mode works via `setVerbose`

**Integration:**
- [ ] Can be imported: `import { uninstallCommand } from './src/commands/uninstall.js'`
- [ ] Uses same logger patterns as install.js
- [ ] Uses same ScopeManager patterns
- [ ] Exit codes match Phase 1 conventions
</verification>

<success_criteria>
Uninstall command is complete and tested:
- ‚úÖ Detects installation scope (global/local/auto)
- ‚úÖ Shows pre-deletion summary with all items
- ‚úÖ Interactive confirmation with default false
- ‚úÖ --force flag for non-interactive use
- ‚úÖ Removes all installation files and directories
- ‚úÖ Proper error handling (permission, not found, interrupted)
- ‚úÖ Correct exit codes (0, 1, 2, 130)
- ‚úÖ Verbose logging support
- ‚úÖ Follows Phase 1 code patterns
- ‚úÖ Full JSDoc documentation

Ready for CLI registration in Plan 02-03.
</success_criteria>

<output>
After completion, create `.planning/phases/02-uninstall-configuration/02-02-SUMMARY.md`
</output>
