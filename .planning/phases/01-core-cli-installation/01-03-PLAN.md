---
phase: 01-core-cli-installation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/services/scope-manager.js
  - src/services/config.js
autonomous: true

must_haves:
  truths:
    - "Scope manager resolves global vs local installation paths"
    - "Config service reads and writes VERSION file"
    - "Custom config directories are supported via --config-dir"
  artifacts:
    - path: "src/services/scope-manager.js"
      provides: "Global/local scope resolution"
      exports: ["ScopeManager"]
    - path: "src/services/config.js"
      provides: "Configuration persistence"
      exports: ["ConfigManager"]
  key_links:
    - from: "src/services/scope-manager.js"
      to: "src/utils/path-resolver.js"
      via: "import"
      pattern: "import { expandPath } from '../utils/path-resolver.js'"
    - from: "src/services/config.js"
      to: "src/services/scope-manager.js"
      via: "constructor injection"
      pattern: "constructor(scopeManager)"
---

<objective>
Create service layer for scope management and configuration persistence. Scope manager handles global vs local path resolution. Config manager reads/writes VERSION file and tracks installation state.

Purpose: Centralize path resolution and configuration management so commands don't need to handle these concerns.
Output: ScopeManager class and ConfigManager class.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/01-core-cli-installation/01-CONTEXT.md
@.planning/phases/01-core-cli-installation/01-01-SUMMARY.md
@.planning/research/ARCHITECTURE.md

## Implementation Notes

From ROADMAP (Phase 1 Requirements):
- INST-01: Install supports --global flag for global installation
- INST-02: Install supports --local flag for local installation
- INST-05: Install supports --config-dir to specify custom directory
- INST-07: Install creates VERSION file to track installed version
- LIST-01: List shows currently installed version
- LIST-02: List shows installation location
- LIST-03: List shows installation scope (global vs local)
- ERROR-04: All commands validate paths to prevent directory traversal

Dependencies: Plan 01-01 (utils layer must exist)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScopeManager service</name>
  <files>src/services/scope-manager.js</files>
  <action>
Create src/services/scope-manager.js with ScopeManager class:

1. Import dependencies:
   - os from 'os'
   - path from 'path'
   - expandPath, validatePath from '../utils/path-resolver.js'
   - DEFAULT_CONFIG_DIR from '../../lib/constants.js'

2. Create ScopeManager class with constructor(options):
   - options: { scope: 'global'|'local', configDir: string }
   - this.globalDir = options.configDir || process.env.OPENCODE_CONFIG_DIR || path.join(os.homedir(), '.config', 'opencode')
   - this.localDir = path.join(process.cwd(), '.opencode')
   - this.scope = options.scope
   - Validate globalDir using validatePath to prevent traversal

3. Implement methods:
   - getTargetDir(): Returns installation path based on scope
   - getPathPrefix(): Returns display-friendly path prefix
   - isInstalled(): Check if VERSION file exists
   - getInstalledVersion(): Read version from VERSION file
   - getScope(): Return current scope
   - isGlobal(): Return true if scope is 'global'
   - isLocal(): Return true if scope is 'local'
   - isCustomConfig(): Return true if using non-default config dir

4. Add JSDoc for all methods

Example usage:
import { ScopeManager } from './services/scope-manager.js';
const scope = new ScopeManager({ scope: 'global' });
console.log(scope.getTargetDir());
console.log(scope.isInstalled());

Error handling: Throw if configDir contains path traversal, validate all paths
  </action>
  <verify>
Test: node -e "import('./src/services/scope-manager.js').then(m => { const s = new m.ScopeManager({scope:'global'}); console.log(s.getTargetDir(), s.isGlobal()); })"
Expected: Shows path and true
  </verify>
  <done>ScopeManager correctly resolves paths and detects installation status</done>
</task>

<task type="auto">
  <name>Task 2: Create ConfigManager service</name>
  <files>src/services/config.js</files>
  <action>
Create src/services/config.js with ConfigManager class:

1. Import dependencies:
   - fs/promises as fs
   - path from 'path'
   - VERSION_FILE from '../../lib/constants.js'
   - ScopeManager

2. Create ConfigManager class with constructor(scopeManager)

3. Implement methods:
   - async getVersion(): Read installed version from VERSION file
   - async setVersion(version): Write version to VERSION file
   - async isInstalled(): Check if VERSION file exists
   - async getInstallationInfo(): Returns object with installed, version, location, scope, pathPrefix
   - getTargetDir(): Delegate to scopeManager.getTargetDir()
   - _getVersionPath(): Private method returning full path to VERSION file

4. Add JSDoc for all methods

Example usage:
import { ScopeManager } from './services/scope-manager.js';
import { ConfigManager } from './services/config.js';
const scope = new ScopeManager({ scope: 'global' });
const config = new ConfigManager(scope);
const info = await config.getInstallationInfo();

Error handling: Handle EACCES and ENOENT gracefully with helpful messages
  </action>
  <verify>
Test: node -e "import('./src/services/config.js').then(async m => { const s = {getTargetDir: () => '/tmp/test', isGlobal: () => true}; const c = new m.ConfigManager(s); console.log(c.getTargetDir()); })"
Expected: Shows target directory path
  </verify>
  <done>ConfigManager reads and writes VERSION file correctly</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run: node -e "import('./src/services/scope-manager.js')"
2. Run: node -e "import('./src/services/config.js')"
3. Verify ScopeManager returns correct paths
4. Verify ConfigManager can read VERSION file
</verification>

<success_criteria>
- ScopeManager resolves global path to ~/.config/opencode
- ScopeManager resolves local path to ./.opencode
- ScopeManager detects installation status via VERSION file
- ConfigManager reads VERSION file from target directory
- ConfigManager writes VERSION file to target directory
- ConfigManager.getInstallationInfo() returns complete info object
- Path validation prevents directory traversal attacks
- Both services can be imported and used without errors
</success_criteria>

<output>
After completion, create .planning/phases/01-core-cli-installation/01-03-SUMMARY.md
</output>
