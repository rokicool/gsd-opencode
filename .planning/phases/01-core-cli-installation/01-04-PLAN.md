---
phase: 01-core-cli-installation
plan: 04
type: execute
wave: 2
depends_on: ["01-01", "01-03"]
files_modified:
  - src/services/file-ops.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "File operations support path replacement in .md files"
    - "Atomic operations use temp-then-move pattern"
    - "Progress indicators show during file copy operations"
    - "Path traversal attacks are blocked during file operations"
  artifacts:
    - path: "src/services/file-ops.js"
      provides: "File operations with path replacement and atomic install"
      exports: ["FileOperations"]
    - path: "package.json"
      provides: "ora dependency for progress indicators"
      contains: "ora"
  key_links:
    - from: "src/services/file-ops.js"
      to: "src/utils/logger.js"
      via: "constructor injection"
      pattern: "constructor(scopeManager, logger)"
    - from: "src/services/file-ops.js"
      to: "src/utils/path-resolver.js"
      via: "import"
      pattern: "import { validatePath }"
    - from: "src/services/file-ops.js"
      to: "ora"
      via: "import"
      pattern: "import { ora } from 'ora'"
---

<objective>
Create file operations service that handles copying files with path replacement, atomic installation, and progress indication. This is the core service that performs the actual installation work.

Purpose: Provide safe, atomic file operations with path replacement in .md files and visual progress feedback.
Output: FileOperations class with install, copyWithPathReplacement, and cleanup methods.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/01-core-cli-installation/01-CONTEXT.md
@.planning/phases/01-core-cli-installation/01-01-SUMMARY.md
@.planning/phases/01-core-cli-installation/01-03-SUMMARY.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md

## Implementation Notes

From ROADMAP (Phase 1 Requirements):
- INST-04: Install performs path replacement in .md files (rewrite @gsd-opencode/ references)
- INST-06: Install shows clear progress indicators during file operations
- INST-08: Install validates target paths to prevent path traversal attacks
- INST-09: Install uses atomic operations (temp-then-move) to prevent partial installations
- INST-10: Install handles permission errors gracefully with helpful error messages
- ERROR-02: All commands handle signal interrupts (SIGINT/SIGTERM) gracefully with cleanup

From PITFALLS.md:
- Path Traversal: Always validate target paths using path.resolve()
- Partial Installation: Implement atomic installation (write to temp, then move)
- Signal Handling: Install SIGINT/SIGTERM handlers for cleanup

Dependencies: Plan 01-01 (logger), Plan 01-03 (scope-manager)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install ora dependency for progress indicators</name>
  <files>package.json</files>
  <action>
Install ora package for loading spinners and progress indication:

1. Run: npm install ora@^9.3.0

2. Verify installation:
   - Check node_modules/ora exists
   - Check package.json shows the dependency

3. Note: ora is ESM-only and provides elegant terminal spinners
  </action>
  <verify>
Run: node -e "import('ora').then(m => console.log(typeof m.default))"
Expected: Should show 'function'
  </verify>
  <done>ora installed and importable</done>
</task>

<task type="auto">
  <name>Task 2: Create FileOperations service with atomic install and path replacement</name>
  <files>src/services/file-ops.js</files>
  <action>
Create src/services/file-ops.js with FileOperations class:

1. Import dependencies:
   - fs/promises as fs
   - path from 'path'
   - ora from 'ora'
   - validatePath from '../utils/path-resolver.js'
   - PATH_PATTERNS, DIRECTORIES_TO_COPY from '../../lib/constants.js'

2. Create FileOperations class with constructor(scopeManager, logger):
   - Store scopeManager and logger references
   - Initialize cleanup registry for temp directories

3. Implement install(sourceDir, targetDir) method:
   - Validate targetDir using validatePath to prevent traversal
   - Create temp directory (targetDir + '.tmp-' + timestamp)
   - Copy all files from sourceDir to temp directory with progress
   - Perform path replacement on .md files in temp directory
   - Move temp directory to targetDir (atomic operation)
   - Return { success: true, filesCopied: count, directories: count }

4. Implement copyWithPathReplacement(sourceDir, targetDir) method:
   - Copy files recursively from source to target
   - For each .md file: read content, replace @gsd-opencode/ with actual path
   - Write modified content to target
   - Track files copied and directories created
   - Show progress via logger or ora spinner

5. Implement atomic move method:
   - Move temp directory to final location atomically
   - Handle cross-device move if needed (copy + delete)
   - Return true on success

6. Implement cleanup handlers:
   - registerTempDir(path): Add temp dir to cleanup registry
   - cleanup(): Remove all registered temp directories
   - setupSignalHandlers(): Register SIGINT/SIGTERM handlers that call cleanup

7. Implement progress indication:
   - Use ora for spinner during copy operations
   - Show current file being processed
   - Show percentage complete
   - Update logger with progress messages

8. Implement error handling:
   - Catch permission errors (EACCES) with helpful message
   - Catch disk full errors (ENOSPC)
   - Ensure cleanup runs on error
   - Wrap errors with context about operation

9. Add JSDoc for all methods

Key security requirements:
- Validate targetDir prevents traversal (already in targetDir from ScopeManager)
- Use temp-then-move pattern for atomicity
- Clean up temp directories on interrupt
- Validate all paths before operations

Example usage:
import { FileOperations } from './services/file-ops.js';
const fileOps = new FileOperations(scopeManager, logger);
await fileOps.install('./get-shit-done', '/Users/name/.config/opencode');
  </action>
  <verify>
Test module loads:
node -e "import('./src/services/file-ops.js').then(m => console.log('FileOperations:', typeof m.FileOperations))"
Expected: Shows FileOperations is a function/class
  </verify>
  <done>FileOperations class created with install and path replacement methods</done>
</task>

<task type="auto">
  <name>Task 3: Implement signal handling for cleanup</name>
  <files>src/services/file-ops.js</files>
  <action>
Add signal handling to FileOperations class:

1. Add setupSignalHandlers() method:
   - Register SIGINT handler (Ctrl+C)
   - Register SIGTERM handler
   - On signal: run cleanup(), then exit with code 130

2. Update constructor to:
   - Call setupSignalHandlers()
   - Store registered handlers for removal on completion

3. Add removeSignalHandlers() method:
   - Remove SIGINT and SIGTERM handlers
   - Call this after successful installation

4. Ensure cleanup registry works:
   - Store temp directory paths in Set
   - Remove paths after successful move (no longer temp)
   - On signal/error: delete all paths in registry

5. Test behavior:
   - During long copy operation, pressing Ctrl+C should:
     * Stop the operation
     * Delete partial temp directory
     * Show "Installation cancelled" message
     * Exit with code 130

Integration with install():
- Before starting: register temp dir, setup handlers
- After success: remove handlers, clear registry
- On error: cleanup, remove handlers, throw error

Note: This ensures INST-09 (atomic operations) and ERROR-02 (signal handling) requirements are met.
  </action>
  <verify>
Test signal handling logic exists in file (grep for SIGINT/SIGTERM)
  </verify>
  <done>Signal handlers registered that cleanup temp directories on interrupt</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run: node -e "import('./src/services/file-ops.js')" - should not throw
2. Verify ora is in package.json dependencies
3. Verify FileOperations can be instantiated with mock scopeManager and logger
</verification>

<success_criteria>
- FileOperations.install() copies files with atomic temp-then-move
- Path replacement works on .md files (replaces @gsd-opencode/)
- Progress indicators show during file operations
- Signal handlers cleanup temp directories on SIGINT/SIGTERM
- Path traversal is blocked via validatePath
- Permission errors show helpful messages
- Service can be imported and used without errors
</success_criteria>

<output>
After completion, create .planning/phases/01-core-cli-installation/01-04-SUMMARY.md
</output>
