# Phase 6.1: Config Reference - Research

**Researched:** 2026-01-22
**Domain:** OpenCode configuration / variable substitution
**Confidence:** HIGH

## Summary

This research investigates whether opencode.json can directly reference config.json through environment variables or file references, eliminating the need to regenerate opencode.json when profiles change.

**Key findings:**
1. OpenCode supports `{env:VARIABLE_NAME}` and `{file:path}` variable substitution in config files
2. `{file:...}` reads **entire file contents as a string**, not JSON paths — it cannot extract `config.profiles.balanced.planning`
3. `{env:...}` substitutes environment variable values, but OpenCode doesn't source env vars from project files at startup
4. The current "regenerate opencode.json on profile change" approach is the correct architectural pattern for OpenCode

**Primary recommendation:** Keep the current regeneration approach. OpenCode's variable substitution is designed for secrets/API keys, not for dynamic model routing from project config files.

## Standard Stack

No new libraries or tools needed for this phase. The investigation reveals the current approach is architecturally correct.

### Current Implementation (confirmed as correct)
| Component | Purpose | Why Standard |
|-----------|---------|--------------|
| `.planning/config.json` | Source of truth for profiles/presets/overrides | GSD pattern, project-scoped |
| `opencode.json` (project) | Derived agent model assignments | OpenCode reads this at startup |
| `/gsd-set-profile` + `/gsd-settings` | Commands that update config.json → regenerate opencode.json | Profile changes take effect immediately |

## Architecture Patterns

### Why Reference Approach Won't Work

**Pattern: OpenCode Variable Substitution**
```json
// What {file:...} does (reads entire file as string):
{
  "provider": {
    "openai": {
      "options": {
        "apiKey": "{file:~/.secrets/openai-key}"
      }
    }
  }
}
// The file content replaces the placeholder AS A STRING
```

**What we'd need (but doesn't exist):**
```json
// INVALID - there's no JSON path extraction
{
  "agent": {
    "gsd-executor": {
      "model": "{file:.planning/config.json#profiles.presets.balanced.execution}"
    }
  }
}
```

**Why env vars also won't work:**
```json
// This COULD work IF the env var is set:
{
  "agent": {
    "gsd-executor": {
      "model": "{env:GSD_EXECUTION_MODEL}"
    }
  }
}
// BUT: OpenCode doesn't source project .env files
// User would need to manually export vars before launching OpenCode
// Defeats the purpose of profile switching within sessions
```

### Recommended Pattern: Keep Current Regeneration

```
User runs /gsd-set-profile or /gsd-settings
    │
    ▼
Update .planning/config.json
    │
    ▼
Call applyProfile(presetName)
    │
    ├─► Rewrite agent .md frontmatter (model: key)
    │
    └─► Regenerate project opencode.json with derived agent→model mappings
    │
    ▼
OpenCode reloads config (or user restarts session)
```

### Configuration Merge Behavior

OpenCode configs are merged in this order (later overrides earlier):
1. Remote config (organization defaults)
2. Global config (`~/.config/opencode/opencode.json`)
3. Custom config (`OPENCODE_CONFIG` env var)
4. Project config (`opencode.json` in project root)

This means project-level `opencode.json` with explicit agent model assignments will correctly override any global/remote defaults.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Dynamic model routing | Custom OpenCode plugin for config.json parsing | Regenerate opencode.json on profile change | Variable substitution is for secrets, not JSON path extraction |
| Env var injection | Wrapper script that exports vars from config.json | Regenerate opencode.json on profile change | OpenCode doesn't source project env files; would require external launcher |
| JSON path references | Custom `{jsonpath:...}` syntax proposal | Regenerate opencode.json on profile change | Would require OpenCode core changes; regeneration is simpler |

**Key insight:** The regeneration approach is architecturally correct. OpenCode is designed to read static config at startup, not dynamically resolve values from other files at runtime.

## Common Pitfalls

### Pitfall 1: Assuming {file:...} Extracts JSON Paths
**What goes wrong:** Developer assumes `{file:./config.json}` can extract `profiles.presets.balanced.execution`
**Why it happens:** Confusion between file content substitution and JSON path traversal
**How to avoid:** Understand that `{file:...}` reads entire file contents as a string
**Warning signs:** Trying to use path syntax like `{file:config.json#key.nested}`

### Pitfall 2: Env Var Approach Requires External Launcher
**What goes wrong:** Setting up `{env:GSD_EXECUTION_MODEL}` but OpenCode doesn't see the value
**Why it happens:** OpenCode reads shell environment, not project .env files
**How to avoid:** Don't use env vars for project-scoped model routing
**Warning signs:** Values work when manually exported, fail in normal OpenCode startup

### Pitfall 3: Forgetting Agent Frontmatter is Also a Model Source
**What goes wrong:** Only updating opencode.json but not agent frontmatter
**Why it happens:** OpenCode has two model assignment mechanisms (agent config + frontmatter)
**How to avoid:** Current implementation correctly updates both via `applyProfile()`
**Warning signs:** Agent uses unexpected model despite opencode.json being correct

## Code Examples

### Current Implementation (Correct)

**Agent frontmatter with model key:**
```yaml
---
name: gsd-executor
description: Executes GSD plans...
model: opencode/minimax-m2.1-free  # ← Set by applyProfile()
tools:
  read: true
  write: true
---
```

**Project opencode.json (derived from config.json):**
```json
{
  "$schema": "https://opencode.ai/config.json",
  "agent": {
    "gsd-planner": {
      "model": "opencode/glm-4.7-free"
    },
    "gsd-executor": {
      "model": "opencode/minimax-m2.1-free"
    },
    "gsd-verifier": {
      "model": "opencode/glm-4.7-free"
    }
  }
}
```

### What Variable Substitution Actually Does

**Valid use case (secrets):**
```json
{
  "provider": {
    "anthropic": {
      "options": {
        "apiKey": "{file:~/.secrets/anthropic-key}"
      }
    }
  },
  "mcp": {
    "github": {
      "headers": {
        "Authorization": "Bearer {env:GITHUB_MCP_PAT}"
      }
    }
  }
}
```

**File content is substituted as string, not parsed:**
```json
// ~/.secrets/anthropic-key contains: sk-ant-api03-xxx...
// Result after substitution:
{
  "provider": {
    "anthropic": {
      "options": {
        "apiKey": "sk-ant-api03-xxx..."
      }
    }
  }
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| N/A | Regenerate opencode.json on profile change | Phase 5 (current) | Working implementation |

**No change needed:** The current regeneration approach is correct and matches OpenCode's design.

## Open Questions

### Resolved: Can Variable Substitution Solve This?

**Answer: No.** OpenCode's `{file:...}` and `{env:...}` are designed for:
- Secrets management (API keys)
- Including instruction files
- Runtime overrides via env vars

They are NOT designed for:
- JSON path extraction from config files
- Dynamic resolution at config load time
- Project-scoped settings sourced from other project files

### Potential Future Enhancement

If OpenCode ever adds JSON path extraction syntax like:
```json
"model": "{jsonfile:.planning/config.json#$.profiles.presets[$.profiles.active_profile].planning}"
```

Then this approach could be revisited. However:
1. This would require OpenCode core changes
2. The current regeneration approach works and is simpler
3. Profile changes are infrequent; regeneration cost is minimal

## Feasibility Assessment

### Approach 1: Environment Variable Reference
**Feasibility:** LOW
- OpenCode supports `{env:VAR}` syntax ✓
- But OpenCode doesn't source project .env files ✗
- Would require external wrapper script to export vars ✗
- Profile switching within sessions wouldn't work ✗

### Approach 2: File Content Reference
**Feasibility:** NONE
- OpenCode supports `{file:path}` syntax ✓
- But it reads ENTIRE file contents as string ✗
- No JSON path extraction capability ✗
- Can't extract `config.profiles.balanced.planning` value ✗

### Approach 3: Config Merge Trick
**Feasibility:** LOW
- OpenCode merges configs (remote → global → project) ✓
- But merge is at key level, not value derivation ✗
- Can't make one config key derived from another config file ✗

### Approach 4: Keep Current Regeneration (RECOMMENDED)
**Feasibility:** HIGH (already implemented)
- `/gsd-set-profile` updates config.json ✓
- Calls `applyProfile()` to rewrite agent frontmatter ✓
- Regenerates opencode.json with derived model assignments ✓
- Profile changes take effect after restart/reload ✓

## Recommendation

**Keep the current implementation.** Phase 6.1 should be marked as "investigated and closed" rather than implemented.

**Rationale:**
1. OpenCode's variable substitution is designed for secrets, not config derivation
2. No JSON path extraction capability exists in `{file:...}` syntax
3. Env var approach would require external launcher, breaking UX
4. Current regeneration approach is architecturally correct and working
5. Profile changes are infrequent; regeneration cost is acceptable

**Suggested outcome:**
- Update STATE.md to note investigation completed
- Close Phase 6.1 as "no change needed"
- Document finding for future reference

## Sources

### Primary (HIGH confidence)
- OpenCode official documentation: https://opencode.ai/docs/config
  - Variables section: `{env:...}` and `{file:...}` syntax confirmed
  - Config merge behavior confirmed
  - Agent configuration section reviewed

- OpenCode agents documentation: https://opencode.ai/docs/agents
  - Agent model override via `model` key confirmed
  - Markdown frontmatter format confirmed

### Secondary (HIGH confidence)
- Direct inspection of current implementation:
  - `.planning/config.json` structure
  - `gsd-opencode/agents/*.md` frontmatter
  - Project opencode.json example from `/Users/dpearson/repos/claudeTest/opencode.json`
  - Phase 5 PLAN.md files documenting applyProfile() behavior

## Metadata

**Confidence breakdown:**
- Variable substitution capabilities: HIGH - verified against official docs
- Env var behavior: HIGH - verified against official docs
- File reference behavior: HIGH - verified against official docs
- Recommendation: HIGH - based on verified capabilities

**Research date:** 2026-01-22
**Valid until:** Indefinite (unless OpenCode adds JSON path extraction)
