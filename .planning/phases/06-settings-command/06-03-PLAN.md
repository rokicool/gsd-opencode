---
phase: 06-settings-command
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd-opencode/bin/install.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "After installation, /gsd-settings and /gsd-set-profile run in ANY repo without ENOENT errors caused by repo-local 'gsd-opencode/' paths."
    - "Installed markdown prompts contain only install-relative references (e.g. ~/.config/opencode/... or ./.opencode/...), not '@gsd-opencode/...' or 'gsd-opencode/...'."
  artifacts:
    - path: "gsd-opencode/bin/install.js"
      provides: "Install-time rewrite that makes @-references and path constants resolve in non-gsd-opencode repos"
  key_links:
    - from: "gsd-opencode/bin/install.js"
      to: "installed .md files"
      via: "copyWithPathReplacement() string rewrite"
      pattern: "@gsd-opencode/|\\bgsd-opencode/"
---

<objective>
Fix Phase 06 blocker: installed commands reference repo-local paths and crash (ENOENT) in non-gsd-opencode repos.

Purpose: Make Phase 6 commands usable after `npx gsd-opencode` install, regardless of the repo you run them in.
Output: Installer rewrites `@gsd-opencode/...` + `gsd-opencode/...` references into correct installed paths.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-settings-command/06-UAT.md

@gsd-opencode/bin/install.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite repo-local @-references during install</name>
  <files>gsd-opencode/bin/install.js</files>
  <action>
Update the installer’s markdown rewrite step so that copied prompts work outside this repo.

In `copyWithPathReplacement()` (only for `.md` files), extend the replacement rules:

- Replace `@gsd-opencode/` with `@${pathPrefix}`
  - Example (global default): `@gsd-opencode/get-shit-done/lib/config.md` → `@~/.config/opencode/get-shit-done/lib/config.md`
  - Example (local): `@gsd-opencode/get-shit-done/lib/config.md` → `@./.opencode/get-shit-done/lib/config.md`

- Replace plain `gsd-opencode/` (non-@) with `${pathPrefix}`
  - Example: `gsd-opencode/agents/gsd-planner.md` → `~/.config/opencode/agents/gsd-planner.md` (global) or `./.opencode/agents/...` (local)

Constraints:
- Do NOT remove or weaken the existing `~/.claude/` and `./.claude/` rewrites (keep backwards compatibility).
- Ensure replacements run in a safe order so that you don’t double-rewrite (e.g. handle `@gsd-opencode/` before `gsd-opencode/`).
- Only rewrite inside `.md` files (do not mutate JS/JSON content).
  </action>
  <verify>
Deterministic/static scan (non-gsd-opencode repo):
1) Create a fresh repo folder (not inside gsd-opencode):
   - `mkdir -p /tmp/gsd-phase06-test`
   - `git -C /tmp/gsd-phase06-test init`
2) Install locally WITHOUT network (run from this repo checkout):
   - Run the installer script directly with Node, with cwd set to the test repo:

```bash
set -euo pipefail

REPO_ROOT="$(pwd)"
rm -rf /tmp/gsd-phase06-test
mkdir -p /tmp/gsd-phase06-test
git -C /tmp/gsd-phase06-test init

cd /tmp/gsd-phase06-test
node "$REPO_ROOT/gsd-opencode/bin/install.js" --local
```
3) Assert there are ZERO unresolved path tokens inside the install destination:
   - Ensure install destination exists:
     - `test -d /tmp/gsd-phase06-test/.opencode`
   - Assert ZERO unresolved tokens in installed markdown files only (fail on matches, fail on rg error):

```bash
set -euo pipefail

set +e
rg -n "@gsd-opencode/|\\bgsd-opencode/" /tmp/gsd-phase06-test/.opencode \
  --glob "*.md" \
  --no-ignore \
  --hidden \
  --sort path \
  -S
rc=$?
set -e

if [ "$rc" -eq 0 ]; then
  echo "Unexpected repo-local tokens remain in installed markdown"; exit 1
elif [ "$rc" -eq 1 ]; then
  :
else
  echo "rg error (rc=$rc)"; exit "$rc"
fi
```

Manual spot-check:
4) Open installed command files and confirm they contain install-relative paths:
   - `./.opencode/command/gsd/settings.md` contains `@./.opencode/get-shit-done/lib/` (NOT `@gsd-opencode/`).
   - `./.opencode/get-shit-done/lib/agents.md` contains `./.opencode/agents/` (NOT `gsd-opencode/agents/`).

Expected: no occurrences of `@gsd-opencode/` or `gsd-opencode/` remain in installed `.opencode/**/*.md` files.
  </verify>
  <done>
Installed markdown in a non-gsd repo no longer references `@gsd-opencode/*` or `gsd-opencode/*` paths.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add post-install sanity check for unresolved path tokens</name>
  <files>gsd-opencode/bin/install.js</files>
  <action>
After copy completes (global/local), add a lightweight sanity check that scans the destination install directory for unresolved tokens:

- Tokens to detect (case-sensitive):
  - `@gsd-opencode/`
  - `gsd-opencode/`

Behavior:
- Recursively scan only `.md` files inside the install destination (global: `${opencodeDir}`, local: `./.opencode`).
- If any matches are found:
  - Print a clear warning that installation is likely broken in other repos.
  - Print the list of offending files and at least one matching line snippet (keep output readable; max ~10 hits).
- Do NOT fail the install process (exit code 0) — this is a diagnostic.

Rationale: If path rewriting regresses, users immediately see why /gsd-settings is crashing.
  </action>
  <verify>
Deterministic/static:

```bash
set -euo pipefail

# Ensure the sanity-check scan is md-scoped and checks for both tokens.
rg -n --pcre2 '\*\.md|\.md\b|endsWith\(["\x27]\.md["\x27]\)' gsd-opencode/bin/install.js
rg -n "@gsd-opencode/" gsd-opencode/bin/install.js
rg -n "\\bgsd-opencode/" gsd-opencode/bin/install.js
```

Manual:
1) Run `npx gsd-opencode --local` in a fresh repo.
2) Confirm the installer does NOT print the warning.
3) (Optional) Temporarily reintroduce a token in one source `.md` file, reinstall, and confirm the warning prints and points to the installed file.
  </verify>
  <done>
Installer warns if any installed markdown still contains `@gsd-opencode/` or `gsd-opencode/`.
  </done>
</task>

</tasks>

<verification>
In a non-gsd-opencode repo AFTER local install, running `/gsd-settings` and `/gsd-set-profile` must not throw ENOENT errors trying to read/scan `.../gsd-opencode/get-shit-done/lib` (or any other repo-local `gsd-opencode/*` path).
</verification>

<success_criteria>
- Local install produces `.opencode/**` prompts that reference only `.opencode/**` and not repo-local `gsd-opencode/**` paths.
- The UAT blocker “ENOENT scandir .../gsd-opencode/get-shit-done/lib” is no longer reproducible.
</success_criteria>

<output>
After completion, create `.planning/phases/06-settings-command/06-03-SUMMARY.md`
</output>
