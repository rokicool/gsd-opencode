---
phase: 06-settings-command
plan: 04
type: execute
wave: 3
depends_on:
  - "06-02"
  - "06-03"
files_modified:
  - gsd-opencode/command/gsd/settings.md
  - gsd-opencode/agents/gsd-settings.md
  - gsd-opencode/command/gsd/set-profile.md
  - gsd-opencode/agents/gsd-set-profile.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Running /gsd-settings shows the active profile, the stage model table, AND always prints a '* = overridden' legend line."
    - "In /gsd-settings, the action menu is actually interactive (uses the question tool) and the user can complete change-profile, set override, and clear override flows."
    - "In /gsd-set-profile, the Confirm/Edit/Cancel step is unambiguous (question tool choice), and Edit cannot accidentally be triggered by single-letter parsing."
  artifacts:
    - path: "gsd-opencode/command/gsd/settings.md"
      provides: "SOURCE-OF-TRUTH user-facing settings prompt (installed/used entrypoint)"
    - path: "gsd-opencode/command/gsd/set-profile.md"
      provides: "SOURCE-OF-TRUTH user-facing set-profile prompt (installed/used entrypoint)"
    - path: "gsd-opencode/agents/gsd-settings.md"
      provides: "Synced mirror of command/gsd/settings.md (must not drift)"
    - path: "gsd-opencode/agents/gsd-set-profile.md"
      provides: "Synced mirror of command/gsd/set-profile.md (must not drift)"
  key_links:
    - from: "gsd-opencode/command/gsd/settings.md"
      to: "OpenCode question tool"
      via: "menu selection + stage selection + confirm prompts"
      pattern: "question"
    - from: "gsd-opencode/command/gsd/set-profile.md"
      to: "OpenCode question tool"
      via: "profile picker + confirm/edit/cancel choice"
      pattern: "question"
    - from: "gsd-opencode/bin/install.js"
      to: "installed command entrypoints"
      via: "copy/install mapping that places command/gsd/* into the install destination"
      pattern: "command/gsd"
---

<objective>
Fix Phase 06 usability failures: commands degrade into non-interactive printed text and omit required legend output; set-profile confirm/edit flow is too ambiguous.

Purpose: Ensure /gsd-settings and /gsd-set-profile always collect user input reliably via the question tool and present required output for UAT.
Output: Hardened prompts with proper `tools:` declarations and explicit question-tool driven menus.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/06-settings-command/06-UAT.md

@gsd-opencode/command/gsd/settings.md
@gsd-opencode/agents/gsd-settings.md
@gsd-opencode/command/gsd/set-profile.md
@gsd-opencode/agents/gsd-set-profile.md

# Install mapping context (how users actually execute these)
@gsd-opencode/bin/install.js
</context>

<tasks>

<task type="auto">
  <name>Task 0: Declare source-of-truth + enforce sync between command/ and agents/ prompt copies</name>
  <files>
gsd-opencode/command/gsd/settings.md
gsd-opencode/command/gsd/set-profile.md
gsd-opencode/agents/gsd-settings.md
gsd-opencode/agents/gsd-set-profile.md
  </files>
  <action>
Clarify and enforce prompt file ownership to prevent drift:

## Source of truth
- Treat `gsd-opencode/command/gsd/settings.md` and `gsd-opencode/command/gsd/set-profile.md` as the ONLY source-of-truth prompts for user-invoked commands.
  - Reason: install places `command/gsd/*` into the destination command directory; these are the entrypoints users actually execute.

## Sync rule
- Keep `gsd-opencode/agents/gsd-settings.md` as an identical mirror of `command/gsd/settings.md`.
- Keep `gsd-opencode/agents/gsd-set-profile.md` as an identical mirror of `command/gsd/set-profile.md`.

Implementation guidance:
- Apply all content changes to `command/gsd/*.md` first.
- Then copy/sync those exact contents into the matching `agents/*.md` files.
- Do NOT allow the two locations to diverge (the purpose is to eliminate regressions where one file is fixed but the installed entrypoint is not).
  </action>
  <verify>
diff -u gsd-opencode/command/gsd/settings.md gsd-opencode/agents/gsd-settings.md
diff -u gsd-opencode/command/gsd/set-profile.md gsd-opencode/agents/gsd-set-profile.md
  </verify>
  <done>
- Both agent prompt copies exist.
- Both agent prompt copies are identical to their corresponding command/ entrypoints.
  </done>
</task>

<task type="auto">
  <name>Task 1: Enable question tool in settings + set-profile prompts (command + agent copies)</name>
  <files>
gsd-opencode/command/gsd/settings.md
gsd-opencode/agents/gsd-settings.md
gsd-opencode/command/gsd/set-profile.md
gsd-opencode/agents/gsd-set-profile.md
  </files>
  <action>
Update frontmatter `tools:` blocks to explicitly enable interactive input.

Add:
- `question: true`

Constraints:
- Keep existing `read: true` and `write: true`.
- Do NOT broaden tool access unnecessarily (no bash unless you can justify it).

Rationale: The UAT shows menu output is printed but not interactive; declaring and requiring the question tool is the primary fix.
  </action>
  <verify>
Manual (after install, in any repo):
1) Open the installed prompt files (`.opencode/command/gsd/settings.md` and `.opencode/command/gsd/set-profile.md` for local installs).
2) Confirm their frontmatter includes:
   - `tools:`
   - `question: true`
  </verify>
  <done>
All four prompt files declare `question: true` in frontmatter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert menus + confirm flows to question-tool selection (no freeform number/letter parsing)</name>
  <files>
gsd-opencode/command/gsd/settings.md
gsd-opencode/agents/gsd-settings.md
gsd-opencode/command/gsd/set-profile.md
gsd-opencode/agents/gsd-set-profile.md
  </files>
  <action>
Harden the prompts so they do not rely on freeform user input for core navigation.

For `/gsd-settings`:
- Replace the “Selection:” loop (numbers 1-4) with a question-tool choice list:
  - Change active profile
  - Edit stage override (active profile)
  - Clear stage override (active profile)
  - Exit
- Replace stage selection (planning/execution/verification) with question-tool choice list.
- Replace confirmations (Confirm? [y/N]) with explicit question-tool choices: Confirm / Cancel.
- Ensure cancel/back always returns to the main menu without changing config.

For `/gsd-set-profile`:
- Replace the no-args “Type a number (1-3) or 'cancel'” with question-tool profile picker (quality/balanced/budget + cancel).
- Replace the Confirm/Edit/Cancel prompt with a question-tool choice list containing exactly:
  - Confirm change
  - Edit proposed stage models
  - Cancel
- Remove (or de-emphasize) single-letter parsing so the user cannot accidentally trigger Edit/Confirm by typing `c` or `e`.
- In the Edit flow, keep the existing per-stage text prompts for model IDs, but end with a question-tool choice to Confirm / Edit again / Cancel.

Constraints:
- Preserve the already-planned ordering guarantees (write overrides before applyProfile, etc.).
- Keep output tables the same shape so existing docs remain valid.
  </action>
  <verify>
Manual (non-gsd-opencode repo, after install):
1) Run `/gsd-settings`.
2) Confirm the action menu renders as an interactive selection (not printed-only text).
3) Choose “Change active profile” and complete a profile switch; confirm you are prompted with an interactive Confirm/Cancel.
4) Choose “Edit stage override” and set an override; confirm you are prompted with an interactive Confirm/Cancel.
5) Choose “Clear stage override” and clear it; confirm you are prompted with an interactive Confirm/Cancel.

Then run `/gsd-set-profile`:
6) Confirm profile selection is interactive.
7) At the preview step, confirm Confirm/Edit/Cancel is interactive and unambiguous.
8) Choose “Edit proposed stage models”; confirm you can edit then use interactive Confirm/Cancel.
  </verify>
  <done>
Both commands use question-tool selection for menus and confirmations; user can complete flows without typing numeric/letter commands.
  </done>
</task>

<task type="auto">
  <name>Task 3: Make '* = overridden' legend an unconditional required output line in /gsd-settings</name>
  <files>
gsd-opencode/command/gsd/settings.md
gsd-opencode/agents/gsd-settings.md
  </files>
  <action>
Update the `/gsd-settings` prompt text so the legend is REQUIRED output, not just shown in an example block.

Implementation guidance (prompt wording changes):
- In the “Always start by showing current state” section, add an explicit MUST sentence:
  - “After printing the table, ALWAYS print a legend line: `* = overridden` (even if no stages are overridden).”
- Ensure the table rendering instructions explicitly mention:
  - overridden rows must append `*` to the model value
  - legend prints on its own line immediately after the table (before “Config: ...” or immediately after, but consistently)

Rationale: UAT failure shows the legend can be omitted when treated as optional/example.
  </action>
  <verify>
Manual (non-gsd-opencode repo, after install):
1) Run `/gsd-settings` with NO overrides set.
2) Confirm output includes a standalone line: `* = overridden`.
3) Set an override for one stage (e.g. execution).
4) Re-run `/gsd-settings` and confirm:
   - the overridden stage’s model shows a trailing `*`
   - the legend line is still present
  </verify>
  <done>
UAT test #1 expectation is satisfied: legend always prints and overridden stages show `*` markers.
  </done>
</task>

</tasks>

<verification>
End-to-end (user-run) verification in a separate repo after installation:
1) `npx gsd-opencode --local`
2) Start OpenCode in that repo.
3) Run `/gsd-settings` and `/gsd-set-profile` and confirm both are interactive and do not rely on freeform number/letter parsing.
4) (Drift guard) Confirm the installed entrypoints are the command versions:
   - open `./.opencode/command/gsd/settings.md` and `./.opencode/command/gsd/set-profile.md`
   - confirm they contain the question-tool menu wording and required legend instructions
</verification>

<success_criteria>
- Phase 06 UAT tests #1, #2, #3, #4, #6 are no longer reproducible as failures.
- Menus are interactive via question tool; legend output is guaranteed.
</success_criteria>

<output>
After completion, create `.planning/phases/06-settings-command/06-04-SUMMARY.md`
</output>
