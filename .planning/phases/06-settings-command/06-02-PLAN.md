---
phase: 06-settings-command
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - gsd-opencode/command/gsd/settings.md
  - gsd-opencode/agents/gsd-settings.md
autonomous: true

must_haves:
  truths:
    - "Running /gsd-settings displays the active profile and the effective model used for planning/execution/verification"
    - "The settings display marks overridden stages inline and includes a legend explaining the marker"
    - "An interactive loop lets the user change active profile and edit/clear per-stage overrides, persisting after each confirmed action"
    - "After changing profile or overrides, agent frontmatter is updated by applying the active profile (so OpenCode actually uses the new models)"
  artifacts:
    - path: "gsd-opencode/agents/gsd-settings.md"
      provides: "Mirror copy of /gsd-settings prompt (kept in sync with command entrypoint)"
      contains: "name: gsd-settings"
    - path: "gsd-opencode/command/gsd/settings.md"
      provides: "User-facing /gsd-settings command entrypoint (installed and invoked in other repos)"
      contains: "name: gsd-settings"
  key_links:
    - from: "gsd-opencode/command/gsd/settings.md"
      to: "gsd-opencode/get-shit-done/lib/config.md"
      via: "@-reference + readConfig/getActiveProfile/getPresetConfig/getEffectiveStageModels"
      pattern: "@gsd-opencode/get-shit-done/lib/config.md"
    - from: "gsd-opencode/command/gsd/settings.md"
      to: "gsd-opencode/get-shit-done/lib/agents.md"
      via: "@-reference + applyProfile()"
      pattern: "applyProfile\\("
    - from: "gsd-opencode/command/gsd/settings.md"
      to: ".planning/config.json"
      via: "writeConfig() persistence"
      pattern: "\\.planning/config\\.json"
---

<objective>
Implement `/gsd-settings` as an interactive settings command for model profiles.

Purpose: Users need a single place to see their current profile + effective stage models, and to safely adjust profile/overrides with confirmation and persistence.

Output:
- New user-facing command prompt entrypoint: `gsd-opencode/command/gsd/settings.md`
- Synced mirror copy: `gsd-opencode/agents/gsd-settings.md`
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase vision / locked decisions
@.planning/phases/06-settings-command/06-CONTEXT.md

# Libraries to reference
@gsd-opencode/get-shit-done/lib/config.md
@gsd-opencode/get-shit-done/lib/agents.md

# Existing command patterns to mirror
@gsd-opencode/agents/gsd-set-profile.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /gsd-settings command entrypoint with settings table + interactive loop</name>
  <files>gsd-opencode/command/gsd/settings.md</files>
  <action>
Create `gsd-opencode/command/gsd/settings.md` as the user-invoked `/gsd-settings` command prompt (mirrors `gsd-set-profile.md` style).

Important: The file in `gsd-opencode/command/gsd/settings.md` is the installed/used entrypoint in other repos; do NOT implement the feature only in an `agents/` copy.

## 1) YAML frontmatter

Include at least:

- `name: gsd-settings`
- `description: ...`
- `tools:` should allow what the command needs (minimum: `read: true`, `write: true`)

## 2) Context references

In `<context>`, @-reference:

- `@.planning/config.json`
- `@gsd-opencode/get-shit-done/lib/config.md`
- `@gsd-opencode/get-shit-done/lib/agents.md`

## 3) Default display (always shown first)

Follow Phase 06 context decisions:

- Print active profile
- Print settings table for stages (planning/execution/verification)
- Table shows **effective** models (preset + per-profile overrides)
- Inline `*` marker on the model value when that stage is overridden for the active profile
- Include a legend: `* = overridden`
- Include the config path (`.planning/config.json`) and note it is editable
- After printing the table, immediately show the action menu

Implementation detail for override markers:

- Compute `preset = getPresetConfig(activeProfile)` (raw)
- Compute `effective = getEffectiveStageModels(activeProfile)` (effective)
- A stage is overridden if `effective[stage] !== preset[stage]`

## 4) Interactive menu loop (not a one-shot wizard)

Implement a loop that runs until Exit.

Suggested menu (exact wording up to you, but keep these capabilities):

1. Change active profile
2. Edit stage override (for active profile)
3. Clear stage override (for active profile)
4. Exit

## 5) Change active profile flow

- Let user select `quality | balanced | budget`.
- Show a preview table (current vs new) using **effective** stage models for both profiles.
- Confirm before applying.
- On confirm:
  1) call `setActiveProfile(newProfile)`
  2) call `applyProfile(newProfile)` so agent frontmatter updates
  3) print a short `Saved` confirmation
  4) reprint the settings table and show the menu again

## 6) Override edit flow (per-stage)

Follow Phase 06 decisions:

- Start by selecting a stage (planning/execution/verification)
- Then pick the model
- Allow per-stage clear (either via explicit Clear menu item or via selecting a "(clear override)" option)
- Confirm showing old vs new for that stage
- Persist after each confirmed action (no save-on-exit)

Known model list:

- Minimum requirement: provide a picker list derived from the current preset mappings (union of all stage model values from `config.profiles.presets`).
- Also provide a manual entry escape hatch: "Enter a custom model id".
- When user enters a custom model id, accept it as a string (no external model availability checking in this phase).

On confirm of an override change:

1) Update config under the per-profile override path:
   - `profiles.custom_overrides.{activeProfile}.{stage}`
   - For clear: remove that stage key from the `{activeProfile}` override object (keep config minimal).
2) Persist via `writeConfig()` (deep-merge + preserving unknown keys).
3) Apply active profile to agents via `applyProfile(activeProfile)`.
4) Print `Saved` + reprint table + return to menu.

## 7) Legacy override migration (only if needed)

Because Phase 06 requires overrides to be scoped per profile, add a small, safe migration step at the start of the command:

- If `profiles.custom_overrides` uses the legacy global stage shape, migrate it into `profiles.custom_overrides.{activeProfile}` and write config.
- Print a one-time warning/notice like: `⚠ Migrated legacy overrides to be scoped under '{activeProfile}'.`

This prevents old configs from causing overrides to “stick” when switching profiles.

## 8) Error handling

- Invalid menu input re-prompts.
- If `applyProfile()` fails after a config change, clearly report:
  - that config was saved (if it was)
  - which agent rewrite failed and which succeeded (applyProfile provides this)
  - next action: re-run `/gsd-settings` or `git restore gsd-opencode/agents/gsd-*.md`.
  </action>
  <verify>
rg -n "^name:\\s*gsd-settings" gsd-opencode/command/gsd/settings.md
rg -n "@gsd-opencode/get-shit-done/lib/config\\.md" gsd-opencode/command/gsd/settings.md
rg -n "applyProfile\\(" gsd-opencode/command/gsd/settings.md
rg -n "\\* = overridden" gsd-opencode/command/gsd/settings.md
  </verify>
  <done>
- `gsd-opencode/command/gsd/settings.md` exists and is a complete command prompt (no TODO/placeholder text)
- The prompt shows effective stage models with inline override markers and a legend
- The prompt describes an interactive loop with: profile change + per-stage override edit/clear
- Each confirmed action persists to `.planning/config.json` and applies the active profile via `applyProfile()`
  </done>
</task>

<task type="auto">
  <name>Task 2: Keep agent copy in sync with the command entrypoint</name>
  <files>gsd-opencode/agents/gsd-settings.md</files>
  <action>
Create/update `gsd-opencode/agents/gsd-settings.md` as a byte-identical mirror of `gsd-opencode/command/gsd/settings.md`.

Rationale:
- UAT/install runs the command entrypoint under `command/gsd/`.
- Keeping an agent copy in sync prevents drift/regressions when prompts are edited in either location.

Constraints:
- Keep BOTH files declaring `name: gsd-settings` and the same prompt behavior.
- If you need to make further edits to fix content, edit the `command/` file first, then copy/sync into `agents/`.
  </action>
  <verify>
diff -u gsd-opencode/command/gsd/settings.md gsd-opencode/agents/gsd-settings.md
  </verify>
  <done>
- `gsd-opencode/agents/gsd-settings.md` exists.
- `gsd-opencode/agents/gsd-settings.md` is identical to `gsd-opencode/command/gsd/settings.md`.
  </done>
</task>

</tasks>

<verification>
- Manual sanity check (prompt-level):
  - The command always starts by printing current state.
  - The menu is looped (user can do multiple edits).
  - Override changes are written under `profiles.custom_overrides.{profile}.{stage}`.
</verification>

<success_criteria>
- `/gsd-settings` satisfies CMD-02 + CONF-01 from REQUIREMENTS.md.
- Settings UX matches Phase 06 CONTEXT decisions (stage table + inline `*` markers, confirmation flows, loop until Exit).
</success_criteria>

<output>
After completion, create `.planning/phases/06-settings-command/06-02-SUMMARY.md`
</output>
