---
phase: 06-integration-polish
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - tests/integration/path-replacement.test.js
  - tests/integration/commands-integration.test.js
  - tests/helpers/test-utils.js
  - tests/fixtures/integration-source/
autonomous: true
must_haves:
  truths:
    - Install command performs path replacement on .md files
    - Repair command re-applies path replacement correctly
    - Update command preserves path replacements after upgrade
    - All commands work correctly with path-replaced files
    - Path references work at runtime in installed files
  artifacts:
    - path: tests/integration/path-replacement.test.js
      provides: Integration tests for path replacement across commands
      min_lines: 150
    - path: tests/integration/commands-integration.test.js
      provides: End-to-end tests verifying commands work with replaced paths
      min_lines: 200
    - path: tests/helpers/test-utils.js
      provides: Test utilities for temp directories and assertions
      exports: ["createTempDir", "cleanupTempDir", "assertPathReplaced"]
    - path: tests/fixtures/integration-source/
      provides: Full source structure for integration tests
      contains: ["agents/", "command/", "get-shit-done/"]
  key_links:
    - from: tests/integration/
      to: src/commands/
      via: command imports and execution
      pattern: "import.*install|repair|update"
    - from: tests/helpers/test-utils.js
      to: tests/integration/*.test.js
      via: shared utilities
      pattern: "import.*test-utils"
---

<objective>
Create integration tests verifying all commands work correctly with path-replaced files

Purpose: Ensure install, repair, and update commands properly handle path replacement and that path-replaced files are functional
Output: Integration test suite covering complete command workflows with path replacement verification
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/commands/install.js
@src/commands/repair.js
@src/commands/update.js
@src/services/file-ops.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test utilities</name>
  <files>tests/helpers/test-utils.js</files>
  <action>
Create test utility module for integration tests:

File: tests/helpers/test-utils.js

Functions to implement:

1. createTempDir(prefix):
   - Creates temp directory in os.tmpdir()
   - Returns path to temp directory
   - Handles cleanup preparation

2. cleanupTempDir(dirPath):
   - Removes temp directory recursively
   - Handles errors gracefully
   - Safe to call multiple times

3. assertPathReplaced(filePath, expectedPath, scope):
   - Reads .md file content
   - Asserts @gsd-opencode/ is replaced with expectedPath
   - Returns assertion result
   - Scope parameter: 'global' | 'local' | 'custom'

4. createMockSourceDir(tempDir):
   - Creates mock gsd-opencode source structure
   - Includes agents/, command/, get-shit-done/ directories
   - Creates sample .md files with @gsd-opencode/ references
   - Returns path to mock source

5. createMockLogger():
   - Returns mock logger object
   - Captures log output for assertions
   - Silent by default, option for verbose

6. assertNoGsdReferences(dirPath):
   - Recursively scans all .md files in directory
   - Asserts no @gsd-opencode/ references remain
   - Returns list of files that still have references (for debugging)

All functions should be ESM exports and handle errors properly.
  </action>
  <verify>test-utils.js can be imported and all functions work in isolation test</verify>
  <done>Helper module with 6+ utility functions, all working and testable</done>
</task>

<task type="auto">
  <name>Task 2: Create integration test fixtures</name>
  <files>
    tests/fixtures/integration-source/get-shit-done/templates/summary.md
    tests/fixtures/integration-source/agents/test-agent/SKILL.md
    tests/fixtures/integration-source/command/gsd/test.md
  </files>
  <action>
Create realistic integration test fixtures mirroring actual source structure:

tests/fixtures/integration-source/ structure:
```
integration-source/
├── agents/
│   └── test-agent/
│       └── SKILL.md (contains @gsd-opencode/ references)
├── command/
│   └── gsd/
│       └── test.md (contains @gsd-opencode/ references)
└── get-shit-done/
    └── templates/
        └── summary.md (contains @gsd-opencode/ references)
```

Each .md file should have realistic content with @gsd-opencode/ references:

Example summary.md content:
```markdown
---
Note: This references @gsd-opencode/templates/summary.md
Usage: See @gsd-opencode/workflows/execute-plan.md
---

# Summary Template

This template uses files from @gsd-opencode/agents/
```

Include at least 3 .md files with 3+ references each.
Include nested directory structure (agents/test-agent/).
Ensure references appear in various contexts:
- YAML frontmatter
- Headers
- Body text
- Lists

This will be used as the source for install/repair/update tests.
  </action>
  <verify>All fixture files exist with @gsd-opencode/ references, directory structure matches real source</verify>
  <done>3+ .md fixtures in nested structure, each with multiple @gsd-opencode/ references</done>
</task>

<task type="auto">
  <name>Task 3: Create path replacement integration tests</name>
  <files>tests/integration/path-replacement.test.js</files>
  <action>
Create integration tests for path replacement across all commands:

File: tests/integration/path-replacement.test.js

Test suite structure:

1. Install command path replacement:
   describe('install command path replacement', () => {
     test('global install replaces @gsd-opencode/ with ~/.config/opencode/', async () => {
       - Create temp dirs for source and target
       - Mock ScopeManager with scope: 'global'
       - Call install logic (or FileOperations.install)
       - Assert all .md files have paths replaced
       - Assert no @gsd-opencode/ references remain
       - Cleanup
     })

     test('local install replaces @gsd-opencode/ with ./.opencode/', async () => {
       - Similar to above but with scope: 'local'
       - Verify absolute path matches cwd/.opencode/
     })

     test('install preserves file structure while replacing paths', async () => {
       - Verify nested directories maintained
       - Verify all files copied
       - Verify only .md files processed
     })
   })

2. Repair command path replacement:
   describe('repair command path replacement', () => {
     test('repair re-applies path replacement to corrupted files', async () => {
       - Install first to set up target
       - Manually corrupt a file (add @gsd-opencode/ back)
       - Run repair (via RepairService)
       - Assert paths corrected
     })

     test('repair detects and fixes path issues', async () => {
       - Simulate path issues (wrong paths in .md files)
       - Run RepairService.detectIssues()
       - Verify pathIssues detected
       - Run repair
       - Verify paths fixed
     })
   })

3. Update command path replacement:
   describe('update command path replacement', () => {
     test('update preserves existing path replacements', async () => {
       - Install with specific version
       - Verify paths replaced
       - Simulate update (re-install)
       - Verify paths still correctly replaced
       - Verify no duplicate replacements
     })

     test('update re-applies path replacement to new files', async () => {
       - Install
       - Add new .md file to source with @gsd-opencode/
       - Update
       - Verify new file has paths replaced
     })
   })

4. Edge cases:
   test('path replacement handles special characters correctly')
   test('path replacement works with custom config directory')
   test('consecutive installs do not double-replace paths')

Use test utilities from helpers/test-utils.js
Run commands through their service layers for speed (not full CLI)
  </action>
  <verify>npm test runs and all integration tests pass</verify>
  <done>Integration test file with 10+ tests covering install/repair/update path replacement, all passing</done>
</task>

<task type="auto">
  <name>Task 4: Create commands integration tests</name>
  <files>tests/integration/commands-integration.test.js</files>
  <action>
Create end-to-end integration tests verifying commands work with path-replaced files:

File: tests/integration/commands-integration.test.js

These tests verify that after path replacement, the installed files are actually functional:

1. Installed files are valid and parseable:
   test('installed .md files remain valid markdown', async () => {
     - Install to temp dir
     - Read all .md files
     - Verify frontmatter parses correctly
     - Verify markdown structure intact
   })

2. Path references are valid:
   test('replaced paths point to existing files', async () => {
     - Install to temp dir
     - Extract all file references from replaced content
     - Verify referenced files exist in installation
   })

3. Cross-file references work:
   test('workflow files can reference agent files correctly', async () => {
     - Install to temp dir
     - Read workflow file content
     - Follow @-reference paths
     - Verify target files exist and are readable
   })

4. Complete workflow simulation:
   describe('complete workflow with path-replaced files', () => {
     test('full cycle: install -> check -> repair -> update', async () => {
       - Install
       - Run health check (mock or real)
       - Verify no path issues
       - Corrupt a file
       - Run repair
       - Verify fixed
       - Simulate update
       - Verify paths still correct
     })
   })

5. Scope-specific behaviors:
   test('global installation paths are absolute and home-relative')
   test('local installation paths are absolute and cwd-relative')
   test('paths work correctly after directory change')

6. Verification at scale:
   test('all @gsd-opencode/ references replaced in full installation', async () => {
     - Install full source
     - Search ALL .md files for @gsd-opencode/
     - Assert zero occurrences found
   })

These tests ensure the path replacement actually produces working installations.
  </action>
  <verify>npm test runs and all command integration tests pass</verify>
  <done>Integration test file with 8+ end-to-end tests, all passing</done>
</task>

</tasks>

<verification>
- All integration tests pass (15+ tests across two files)
- Tests cover install, repair, update commands
- Tests verify path-replaced files are functional
- Tests verify no @gsd-opencode/ references remain after operations
- Tests verify file structure and formatting preserved
- Helper utilities work correctly and are reusable
</verification>

<success_criteria>
1. Test utilities module created with temp directory and assertion helpers
2. Integration fixtures created with realistic @gsd-opencode/ usage
3. Path replacement integration tests verify all commands handle path replacement
4. Commands integration tests verify path-replaced files are functional
5. All tests pass (100% pass rate)
6. Tests can run in CI environment (no manual setup required)
</success_criteria>

<output>
After completion, create `.planning/phases/06-integration-polish/06-02-SUMMARY.md`
</output>
