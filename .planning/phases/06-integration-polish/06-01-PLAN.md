---
phase: 06-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/unit/file-ops.test.js
  - tests/fixtures/sample-with-references.md
  - tests/fixtures/sample-nested/deep-reference.md
  - package.json
autonomous: true
must_haves:
  truths:
    - Path replacement correctly transforms @gsd-opencode/ to installation paths
    - Global scope rewrites to ~/.config/opencode/
    - Local scope rewrites to ./.opencode/
    - Nested directories have paths replaced correctly
    - File formatting is preserved during path replacement
  artifacts:
    - path: tests/unit/file-ops.test.js
      provides: Unit tests for FileOperations._copyFile
      min_lines: 200
    - path: tests/fixtures/sample-with-references.md
      provides: Test fixture with @gsd-opencode/ references
      contains: "@gsd-opencode/"
    - path: tests/fixtures/sample-nested/deep-reference.md
      provides: Nested directory test fixture
      contains: "@gsd-opencode/"
  key_links:
    - from: tests/unit/file-ops.test.js
      to: src/services/file-ops.js
      via: test imports
      pattern: "import.*FileOperations"
    - from: src/services/file-ops.js
      to: lib/constants.js
      via: PATH_PATTERNS import
      pattern: "PATH_PATTERNS"
---

<objective>
Create comprehensive unit test suite for path replacement functionality in FileOperations service

Purpose: Ensure path replacement works correctly for all scenarios (global/local scope, nested directories, edge cases) before integration testing
Output: Working unit tests that verify _copyFile method performs path replacement correctly
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/services/file-ops.js
@lib/constants.js
@src/services/scope-manager.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up test infrastructure</name>
  <files>package.json, tests/unit/.gitkeep</files>
  <action>
Install test framework (vitest - ESM-native, modern) as dev dependency:
- Add "vitest" to devDependencies in package.json
- Add test scripts: "test": "vitest run", "test:watch": "vitest"
- Create tests/ directory structure: tests/unit/ and tests/fixtures/
- Install dependencies with npm install

Note: Vitest chosen for ESM support without configuration, aligns with project using ES modules.
  </action>
  <verify>npm test command exists and runs (may have 0 tests initially)</verify>
  <done>package.json has vitest devDependency and test scripts, tests/ directory exists</done>
</task>

<task type="auto">
  <name>Task 2: Create test fixtures with @gsd-opencode/ references</name>
  <files>tests/fixtures/sample-with-references.md, tests/fixtures/sample-nested/deep-reference.md, tests/fixtures/sample-without-references.md</files>
  <action>
Create test fixtures that simulate real .md files with @gsd-opencode/ references:

1. tests/fixtures/sample-with-references.md - Simple file with multiple @gsd-opencode/ references:
   - Line: "Source: @gsd-opencode/workflows/execute-plan.md"
   - Line: "Template: @gsd-opencode/templates/summary.md"
   - Line: "Agent: @gsd-opencode/agents/ro-commit/SKILL.md"

2. tests/fixtures/sample-nested/deep-reference.md - Nested directory file:
   - Same reference patterns but in subdirectory
   - Tests recursive directory handling

3. tests/fixtures/sample-without-references.md - Control file without references:
   - Should be copied unchanged
   - Tests that non-.md files are copied directly

4. tests/fixtures/sample-binary.bin - Binary file placeholder:
   - Tests binary files are copied directly, not read as text

Include various formatting to test preservation:
- Code blocks with @gsd-opencode/ references
- Inline references
- List items with references
- Preserve line endings and whitespace
  </action>
  <verify>All fixture files exist with correct content containing @gsd-opencode/ references</verify>
  <done>4+ fixture files created with realistic @gsd-opencode/ usage patterns</done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for FileOperations._copyFile path replacement</name>
  <files>tests/unit/file-ops.test.js</files>
  <action>
Create comprehensive unit tests for path replacement functionality:

Test file: tests/unit/file-ops.test.js

Test cases to implement:

1. Global scope path replacement:
   - Create ScopeManager with scope: 'global'
   - Call _copyFile on .md fixture with @gsd-opencode/ references
   - Assert @gsd-opencode/ replaced with ~/.config/opencode/
   - Verify all occurrences replaced

2. Local scope path replacement:
   - Create ScopeManager with scope: 'local'
   - Call _copyFile on same fixture
   - Assert @gsd-opencode/ replaced with ./.opencode/ (absolute path)
   - Verify correct absolute path for local scope

3. Nested directory handling:
   - Copy fixtures/sample-nested/ structure
   - Verify paths replaced in deeply nested .md files
   - Ensure directory structure preserved

4. File formatting preservation:
   - Test that line endings preserved (LF vs CRLF)
   - Test that whitespace and indentation preserved
   - Test that code blocks maintain formatting
   - Verify file encoding (UTF-8) preserved

5. Non-.md files copied directly:
   - Test binary files are copied without modification
   - Test .txt files are copied without modification (only .md gets replacement)

6. Edge cases:
   - Empty .md file
   - .md file with no @gsd-opencode/ references
   - .md file with multiple references on same line
   - .md file with reference at start/end of content

Use temporary directories (os.tmpdir()) for test isolation.
Clean up temp directories after each test.

Import paths:
- import { FileOperations } from '../../src/services/file-ops.js'
- import { ScopeManager } from '../../src/services/scope-manager.js'
- import { createLogger } from '../../src/utils/logger.js' (or mock logger)
  </action>
  <verify>npm test runs and all path replacement tests pass</verify>
  <done>Unit test file with 10+ test cases covering all path replacement scenarios, all passing</done>
</task>

</tasks>

<verification>
- npm test command works and runs vitest
- All unit tests pass (10+ test cases)
- Tests cover: global scope, local scope, nested directories, formatting preservation, edge cases
- Test fixtures exist with realistic @gsd-opencode/ usage patterns
- Tests verify PATH_PATTERNS.gsdReference regex works correctly
</verification>

<success_criteria>
1. Test infrastructure set up with vitest
2. Test fixtures created with @gsd-opencode/ references in various contexts
3. Unit tests verify path replacement works for global scope (→ ~/.config/opencode/)
4. Unit tests verify path replacement works for local scope (→ ./.opencode/)
5. Unit tests verify nested directory handling
6. Unit tests verify file formatting preservation
7. All tests pass (100% pass rate)
</success_criteria>

<output>
After completion, create `.planning/phases/06-integration-polish/06-01-SUMMARY.md`
</output>
