---
phase: 03-set-profile-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd-opencode/agents/gsd-set-profile.md
autonomous: true

must_haves:
  truths:
    - "User can switch to quality/balanced/budget profile via command"
    - "Profile change shows before/after table before confirmation"
    - "User can confirm, edit inline, or cancel the change"
    - "Already-active profile shows current state without reprompting"
    - "Invalid profile flags show fuzzy match suggestions"
  artifacts:
    - path: "gsd-opencode/agents/gsd-set-profile.md"
      provides: "Set-profile command agent"
      min_lines: 150
      contains: "gsd-set-profile"
  key_links:
    - from: "gsd-opencode/agents/gsd-set-profile.md"
      to: "gsd-opencode/get-shit-done/lib/config.md"
      via: "@-reference"
      pattern: "@.*config\\.md"
---

<objective>
Create the `/gsd-set-profile` command agent that enables users to switch between quality/balanced/budget profiles with a confirmation workflow.

Purpose: Deliver the primary user interface for profile switching — the most common profile management action. This command uses the config library procedures established in Phase 1-2 and adds the interactive confirmation workflow.

Output: A complete agent file at `gsd-opencode/agents/gsd-set-profile.md` that handles flag parsing, profile display, confirmation workflow, inline editing, and edge cases.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-set-profile-command/03-CONTEXT.md

# Config library with procedures
@gsd-opencode/get-shit-done/lib/config.md

# Current config structure
@.planning/config.json

# Agent file patterns
@gsd-opencode/agents/gsd-planner.md (for frontmatter/structure reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agent with flag parsing and profile display</name>
  <files>gsd-opencode/agents/gsd-set-profile.md</files>
  <action>
Create the `/gsd-set-profile` command agent with standard agent frontmatter.

**Frontmatter:**
- name: gsd-set-profile
- description: Switch between model profiles with confirmation workflow
- tools: read, write (for config access)
- color: pick appropriate (e.g., "#4169E1" for royal blue)

**Command invocation section:**
Document two invocation styles:
1. No args: `/gsd-set-profile` — show current profile, then present interactive picker
2. With flag: `/gsd-set-profile --quality` or `-q`, `--balanced` or `-b`, `--budget` or `-u`

**Current profile display:**
- Read config via `readConfig()` 
- Display current active profile and its stage-to-model mappings using `getPresetConfig()`
- Format as a clear table: Stage | Model

**Interactive picker (no-args flow):**
When invoked without flags:
1. Show current profile
2. Present numbered options: [1] quality, [2] balanced, [3] budget
3. Ask user to select or type 'cancel'
4. Proceed to confirmation workflow (Task 2)

**Reference config library:** Include `@gsd-opencode/get-shit-done/lib/config.md` in the agent's context section.
  </action>
  <verify>
File exists at `gsd-opencode/agents/gsd-set-profile.md` with:
- Valid YAML frontmatter (name, description, tools)
- Invocation documentation
- Current profile display logic
- Interactive picker logic
- @-reference to config library
  </verify>
  <done>
Agent file created with flag parsing, profile display, and picker flow documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement confirmation workflow with before/after table</name>
  <files>gsd-opencode/agents/gsd-set-profile.md</files>
  <action>
Add the confirmation workflow section to the agent.

**Before/after table:**
When user selects a profile (via picker or flag), show a comparison table:
```
Profile change: balanced → quality

| Stage        | Current Model              | New Model                  |
|--------------|----------------------------|----------------------------|
| planning     | opencode/minimax-m2.1-free | opencode/glm-4.7-free      |
| execution    | opencode/grok-code         | opencode/glm-4.7-free      |
| verification | opencode/minimax-m2.1-free | opencode/glm-4.7-free      |
```

Use `getPresetConfig(currentProfile)` and `getPresetConfig(newProfile)` to build the table.
Display full model IDs (e.g., `opencode/glm-4.7-free`).

**Three options after preview:**
Present: `[C]onfirm | [E]dit | [X] Cancel`

1. **Confirm**: Call `setActiveProfile(newProfile)`, then show success message with full summary table of what's now active
2. **Edit**: Trigger inline edit flow (Task 3)
3. **Cancel**: Abort with message "Profile change cancelled. Current profile: {profile}"

**Success output:**
On confirm, display:
```
✓ Active profile set to: quality

Current configuration:
| Stage        | Model                 |
|--------------|-----------------------|
| planning     | opencode/glm-4.7-free |
| execution    | opencode/glm-4.7-free |
| verification | opencode/glm-4.7-free |
```
  </action>
  <verify>
Agent file contains:
- Before/after comparison table logic
- Confirm/Edit/Cancel option handling
- Success message with summary table
- Uses getPresetConfig() for model lookups
  </verify>
  <done>
Confirmation workflow with before/after table, three options, and success output documented in agent.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add edge cases and inline edit flow</name>
  <files>gsd-opencode/agents/gsd-set-profile.md</files>
  <action>
Add edge case handling and the inline edit flow.

**Edge case: Already-active profile**
If user selects the profile that's already active:
- Silent success (no error)
- Show current state: "Profile 'balanced' is already active."
- Display current configuration table
- Do NOT show confirmation workflow (nothing to change)

**Edge case: Invalid profile flag**
If user provides an invalid flag (e.g., `--fast`, `-x`):
- Use `validateProfile()` which provides fuzzy match suggestions
- Display: "Unknown profile flag '--fast'. Did you mean '--quality'?"
- Show valid options: `--quality/-q`, `--balanced/-b`, `--budget/-u`
- Do NOT crash — let user retry

**Edge case: Missing/empty config.json**
If `.planning/config.json` doesn't exist or is empty:
- `readConfig()` already handles this (returns defaults)
- Agent should proceed normally with defaults
- On first profile set, `writeConfig()` will create the file

**Edge case: Corrupted JSON**
If config.json is corrupted:
- `readConfig()` already handles this (warns, backs up, uses defaults)
- Agent should proceed with defaults and note the warning

**Inline edit flow (when user selects [E]dit):**
1. Show the proposed profile's stage-to-model mappings
2. For each stage, prompt: "planning [opencode/glm-4.7-free]: " (user can press Enter to keep, or type new model ID)
3. After all three stages, show updated preview table
4. Return to Confirm/Edit/Cancel options
5. Edits are applied to `profiles.custom_overrides` in config.json (not to presets)

Note: The edit flow modifies the NEXT configuration, not the preset itself. Store custom per-stage overrides under `profiles.custom_overrides.{stage}` for the current profile.
  </action>
  <verify>
Agent file contains:
- Already-active profile handling (silent success)
- Invalid flag handling with fuzzy suggestions
- Inline edit flow with per-stage prompts
- Custom overrides stored at profiles.custom_overrides
  </verify>
  <done>
All edge cases documented and inline edit flow added to agent.
  </done>
</task>

</tasks>

<verification>
1. Agent file exists at `gsd-opencode/agents/gsd-set-profile.md`
2. Frontmatter is valid YAML with name, description, tools
3. Agent @-references the config library
4. All invocation styles documented (no-args, flags)
5. Confirmation workflow includes before/after table
6. Three options (Confirm/Edit/Cancel) are handled
7. Edge cases covered (already-active, invalid flag, inline edit)
8. Output formatting uses full model IDs
</verification>

<success_criteria>
- `/gsd-set-profile` agent file is complete and follows agent conventions
- Command supports both no-args (picker) and flag invocation
- Confirmation workflow shows before/after model comparison
- User can confirm, edit inline, or cancel
- Edge cases produce helpful error messages, not crashes
- Config library procedures are properly referenced and used
</success_criteria>

<output>
After completion, create `.planning/phases/03-set-profile-command/03-01-SUMMARY.md`
</output>
